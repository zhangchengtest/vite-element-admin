import{c as ts}from"../@amap/@amap.99378080.js";var Ss={exports:{}};(function(es,vs){(function(tt){es.exports=tt()})(function(){var tt={};function et(e,t,s){return function(i,n){if(i!==n)throw new TypeError("Private static access of wrong provenance")}(e,t),s}Object.defineProperty(tt,"__esModule",{value:!0}),tt.default=void 0;class p{constructor(t){t&&(this.given=typeof t.given=="number"?t.given:p.decode(t.given),this.want=typeof t.want=="number"?t.want:p.decode(t.want),this.mode=t.mode?typeof t.mode=="number"?t.mode:p.decode(t.mode):this.given&this.want)}static decode(t){if(!t)return null;if(typeof t=="number")return t&p._BITMASK;if(t==="N"||t==="n")return p._NONE;const s={J:p._JOIN,R:p._READ,W:p._WRITE,P:p._PRES,A:p._APPROVE,S:p._SHARE,D:p._DELETE,O:p._OWNER};let i=p._NONE;for(let n=0;n<t.length;n++){const a=s[t.charAt(n).toUpperCase()];a&&(i|=a)}return i}static encode(t){if(t===null||t===p._INVALID)return null;if(t===p._NONE)return"N";const s=["J","R","W","P","A","S","D","O"];let i="";for(let n=0;n<s.length;n++)(t&1<<n)!=0&&(i+=s[n]);return i}static update(t,s){if(!s||typeof s!="string")return t;let i=s.charAt(0);if(i=="+"||i=="-"){let n=t;const a=s.split(/([-+])/);for(let o=1;o<a.length-1;o+=2){i=a[o];const l=p.decode(a[o+1]);if(l==p._INVALID)return t;l!=null&&(i==="+"?n|=l:i==="-"&&(n&=~l))}t=n}else{const n=p.decode(s);n!=p._INVALID&&(t=n)}return t}static diff(t,s){return t=p.decode(t),s=p.decode(s),t==p._INVALID||s==p._INVALID?p._INVALID:t&~s}toString(){return'{"mode": "'+p.encode(this.mode)+'", "given": "'+p.encode(this.given)+'", "want": "'+p.encode(this.want)+'"}'}jsonHelper(){return{mode:p.encode(this.mode),given:p.encode(this.given),want:p.encode(this.want)}}setMode(t){return this.mode=p.decode(t),this}updateMode(t){return this.mode=p.update(this.mode,t),this}getMode(){return p.encode(this.mode)}setGiven(t){return this.given=p.decode(t),this}updateGiven(t){return this.given=p.update(this.given,t),this}getGiven(){return p.encode(this.given)}setWant(t){return this.want=p.decode(t),this}updateWant(t){return this.want=p.update(this.want,t),this}getWant(){return p.encode(this.want)}getMissing(){return p.encode(this.want&~this.given)}getExcessive(){return p.encode(this.given&~this.want)}updateAll(t){return t&&(this.updateGiven(t.given),this.updateWant(t.want),this.mode=this.given&this.want),this}isOwner(t){return et(p,p,st).call(p,this,t,p._OWNER)}isPresencer(t){return et(p,p,st).call(p,this,t,p._PRES)}isMuted(t){return!this.isPresencer(t)}isJoiner(t){return et(p,p,st).call(p,this,t,p._JOIN)}isReader(t){return et(p,p,st).call(p,this,t,p._READ)}isWriter(t){return et(p,p,st).call(p,this,t,p._WRITE)}isApprover(t){return et(p,p,st).call(p,this,t,p._APPROVE)}isAdmin(t){return this.isOwner(t)||this.isApprover(t)}isSharer(t){return this.isAdmin(t)||et(p,p,st).call(p,this,t,p._SHARE)}isDeleter(t){return et(p,p,st).call(p,this,t,p._DELETE)}}function st(e,t,s){if(["given","want","mode"].includes(t=t||"mode"))return(e[t]&s)!=0;throw new Error(`Invalid AccessMode component '${t}'`)}tt.default=p,p._NONE=0,p._JOIN=1,p._READ=2,p._WRITE=4,p._PRES=8,p._APPROVE=16,p._SHARE=32,p._DELETE=64,p._OWNER=128,p._BITMASK=p._JOIN|p._READ|p._WRITE|p._PRES|p._APPROVE|p._SHARE|p._DELETE|p._OWNER,p._INVALID=1048576;var w={};Object.defineProperty(w,"__esModule",{value:!0}),w.VERSION=w.USER_NEW=w.TOPIC_SYS=w.TOPIC_P2P=w.TOPIC_NEW_CHAN=w.TOPIC_NEW=w.TOPIC_ME=w.TOPIC_GRP=w.TOPIC_FND=w.TOPIC_CHAN=w.RECV_TIMEOUT=w.PROTOCOL_VERSION=w.MESSAGE_STATUS_TO_ME=w.MESSAGE_STATUS_SENT=w.MESSAGE_STATUS_SENDING=w.MESSAGE_STATUS_RECEIVED=w.MESSAGE_STATUS_READ=w.MESSAGE_STATUS_QUEUED=w.MESSAGE_STATUS_NONE=w.MESSAGE_STATUS_FAILED=w.MESSAGE_STATUS_DEL_RANGE=w.LOCAL_SEQID=w.LIBRARY=w.EXPIRE_PROMISES_TIMEOUT=w.EXPIRE_PROMISES_PERIOD=w.DEL_CHAR=w.DEFAULT_MESSAGES_PAGE=void 0,w.PROTOCOL_VERSION="0",w.VERSION="0.20.2",w.LIBRARY="tinodejs/0.20.2",w.TOPIC_NEW="new",w.TOPIC_NEW_CHAN="nch",w.TOPIC_ME="me",w.TOPIC_FND="fnd",w.TOPIC_SYS="sys",w.TOPIC_CHAN="chn",w.TOPIC_GRP="grp",w.TOPIC_P2P="p2p",w.USER_NEW="new",w.LOCAL_SEQID=268435455,w.MESSAGE_STATUS_NONE=0,w.MESSAGE_STATUS_QUEUED=1,w.MESSAGE_STATUS_SENDING=2,w.MESSAGE_STATUS_FAILED=3,w.MESSAGE_STATUS_SENT=4,w.MESSAGE_STATUS_RECEIVED=5,w.MESSAGE_STATUS_READ=6,w.MESSAGE_STATUS_TO_ME=7,w.MESSAGE_STATUS_DEL_RANGE=8,w.EXPIRE_PROMISES_TIMEOUT=5e3,w.EXPIRE_PROMISES_PERIOD=1e3,w.RECV_TIMEOUT=100,w.DEFAULT_MESSAGES_PAGE=24,w.DEL_CHAR="\u2421";var A={};Object.defineProperty(A,"__esModule",{value:!0}),A.isUrlRelative=function(e){return e&&!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(e)},A.jsonParseHelper=function(e,t){if(typeof t=="string"&&t.length>=20&&t.length<=24&&["ts","touched","updated","created","when","deleted","expires"].includes(e)){const s=new Date(t);if(!isNaN(s))return s}else if(e==="acs"&&typeof t=="object")return new jt.default(t);return t},A.mergeObj=qt,A.mergeToCache=function(e,t,s,i){return e[t]=qt(e[t],s,i),e[t]},A.normalizeArray=function(e){let t=[];if(Array.isArray(e)){for(let s=0,i=e.length;s<i;s++){let n=e[s];n&&(n=n.trim().toLowerCase(),n.length>1&&t.push(n))}t.sort().filter(function(s,i,n){return!i||s!=n[i-1]})}return t.length==0&&t.push(w.DEL_CHAR),t},A.rfc3339DateString=function(e){if(!ae(e))return;const t=function(i,n){return"0".repeat((n=n||2)-(""+i).length)+i},s=e.getUTCMilliseconds();return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+(s?"."+t(s,3):"")+"Z"},A.simplify=function e(t){return Object.keys(t).forEach(s=>{s[0]=="_"?delete t[s]:t[s]?Array.isArray(t[s])&&t[s].length==0?delete t[s]:t[s]?t[s]instanceof Date?ae(t[s])||delete t[s]:typeof t[s]=="object"&&(e(t[s]),Object.getOwnPropertyNames(t[s]).length==0&&delete t[s]):delete t[s]:delete t[s]}),t};var Mt,jt=(Mt=tt)&&Mt.__esModule?Mt:{default:Mt};function ae(e){return e instanceof Date&&!isNaN(e)&&e.getTime()!=0}function qt(e,t,s){if(typeof t!="object")return t===void 0?e:t===w.DEL_CHAR?void 0:t;if(t===null)return t;if(t instanceof Date&&!isNaN(t))return!e||!(e instanceof Date)||isNaN(e)||e<t?t:e;if(t instanceof jt.default)return new jt.default(t);if(t instanceof Array)return t;e&&e!==w.DEL_CHAR||(e=t.constructor());for(let i in t)if(t.hasOwnProperty(i)&&(!s||!s[i])&&i!="_noForwarding")try{e[i]=qt(e[i],t[i])}catch{}return e}var Pt={};function gt(e,t){oe(e,t),t.add(e)}function J(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function At(e,t,s){oe(e,t),t.set(e,s)}function oe(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Q(e,t,s){return he(e,ce(e,t,"set"),s),s}function x(e,t){return de(e,ce(e,t,"get"))}function ce(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}function he(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}function mt(e,t,s){return ue(e,t),le(s,"get"),de(e,s)}function le(e,t){if(e===void 0)throw new TypeError("attempted to "+t+" private static field before its declaration")}function ue(e,t){if(e!==t)throw new TypeError("Private static access of wrong provenance")}function de(e,t){return t.get?t.get.call(e):t.value}function X(e,t,s){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return s}let pe,Lt;function fe(e,t,s,i){let n=null;return["http","https","ws","wss"].includes(t)&&(n=`${t}://${e}`,n.charAt(n.length-1)!=="/"&&(n+="/"),n+="v"+s+"/channels",["http","https"].includes(t)&&(n+="/lp"),n+="?apikey="+i),n}Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.default=void 0;var _t=new WeakMap,it=new WeakMap,K=new WeakMap,G=new WeakMap,Gt=new WeakSet,at=new WeakSet,ge=new WeakSet,me=new WeakSet,_e=new WeakSet;class D{constructor(t,s,i){if(gt(this,_e),gt(this,me),gt(this,ge),gt(this,at),gt(this,Gt),At(this,_t,{writable:!0,value:null}),At(this,it,{writable:!0,value:0}),At(this,K,{writable:!0,value:!1}),At(this,G,{writable:!0,value:null}),J(this,"host",void 0),J(this,"secure",void 0),J(this,"apiKey",void 0),J(this,"version",void 0),J(this,"autoreconnect",void 0),J(this,"initialized",void 0),J(this,"onMessage",void 0),J(this,"onDisconnect",void 0),J(this,"onOpen",void 0),J(this,"onAutoreconnectIteration",void 0),this.host=t.host,this.secure=t.secure,this.apiKey=t.apiKey,this.version=s,this.autoreconnect=i,t.transport==="lp"?(X(this,me,is).call(this),this.initialized="lp"):t.transport==="ws"&&(X(this,_e,ns).call(this),this.initialized="ws"),!this.initialized)throw mt(D,D,ut).call(D,"Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'."),new Error("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.")}static setNetworkProviders(t,s){pe=t,Lt=s}static set logger(t){var s,i,n;i=ut,n=t,ue(s=D,D),le(i,"set"),he(s,i,n)}connect(t,s){return Promise.reject(null)}reconnect(t){}disconnect(){}sendText(t){}isConnected(){return!1}transport(){return this.initialized}probe(){this.sendText("1")}backoffReset(){X(this,ge,ss).call(this)}}function be(){clearTimeout(x(this,_t));const e=Math.pow(2,x(this,it))*(1+.3*Math.random())*2e3;Q(this,it,x(this,it)>=10?x(this,it):x(this,it)+1),this.onAutoreconnectIteration&&this.onAutoreconnectIteration(e),Q(this,_t,setTimeout(t=>{if(mt(D,D,ut).call(D,`Reconnecting, iter=${x(this,it)}, timeout=${e}`),x(this,K))this.onAutoreconnectIteration&&this.onAutoreconnectIteration(-1);else{const s=this.connect();this.onAutoreconnectIteration?this.onAutoreconnectIteration(0,s):s.catch(i=>{})}},e))}function lt(){clearTimeout(x(this,_t)),Q(this,_t,null)}function ss(){Q(this,it,0)}function is(){let e=null,t=null,s=null,i=(n,a,o)=>{let l=new Lt,b=!1;return l.onreadystatechange=g=>{if(l.readyState==4)if(l.status==201){let m=JSON.parse(l.responseText,A.jsonParseHelper);e=n+"&sid="+m.ctrl.params.sid,l=i(e),l.send(null),this.onOpen&&this.onOpen(),a&&(b=!0,a()),this.autoreconnect&&X(this,at,lt).call(this)}else if(l.status<400)this.onMessage&&this.onMessage(l.responseText),l=i(e),l.send(null);else{if(o&&!b&&(b=!0,o(l.responseText)),this.onMessage&&l.responseText&&this.onMessage(l.responseText),this.onDisconnect){const m=l.status||(x(this,K)?418:503),u=l.responseText||(x(this,K)?"Disconnected by client":"Connection failed");this.onDisconnect(new Error(u+" ("+m+")"),m)}l=null,!x(this,K)&&this.autoreconnect&&X(this,Gt,be).call(this)}},l.open("POST",n,!0),l};this.connect=(n,a)=>{if(Q(this,K,!1),t){if(!a)return Promise.resolve();t.onreadystatechange=void 0,t.abort(),t=null}return n&&(this.host=n),new Promise((o,l)=>{const b=fe(this.host,this.secure?"https":"http",this.version,this.apiKey);mt(D,D,ut).call(D,"LP connecting to:",b),t=i(b,o,l),t.send(null)}).catch(o=>{mt(D,D,ut).call(D,"LP connection failed:",o)})},this.reconnect=n=>{X(this,at,lt).call(this),this.connect(null,n)},this.disconnect=()=>{Q(this,K,!0),X(this,at,lt).call(this),s&&(s.onreadystatechange=void 0,s.abort(),s=null),t&&(t.onreadystatechange=void 0,t.abort(),t=null),this.onDisconnect&&this.onDisconnect(new Error("Disconnected by client (418)"),418),e=null},this.sendText=n=>{if(s=(a=>{const o=new Lt;return o.onreadystatechange=l=>{if(o.readyState==4&&o.status>=400)throw new Error("LP sender failed, "+o.status)},o.open("POST",a,!0),o})(e),!s||s.readyState!=1)throw new Error("Long poller failed to connect");s.send(n)},this.isConnected=()=>t&&!0}function ns(){this.connect=(e,t)=>{if(Q(this,K,!1),x(this,G)){if(!t&&x(this,G).readyState==x(this,G).OPEN)return Promise.resolve();x(this,G).close(),Q(this,G,null)}return e&&(this.host=e),new Promise((s,i)=>{const n=fe(this.host,this.secure?"wss":"ws",this.version,this.apiKey);mt(D,D,ut).call(D,"WS connecting to: ",n);const a=new pe(n);a.onerror=o=>{i(o)},a.onopen=o=>{this.autoreconnect&&X(this,at,lt).call(this),this.onOpen&&this.onOpen(),s()},a.onclose=o=>{if(Q(this,G,null),this.onDisconnect){const l=x(this,K)?418:503;this.onDisconnect(new Error(x(this,K)?"Disconnected by client":"Connection failed ("+l+")"),l)}!x(this,K)&&this.autoreconnect&&X(this,Gt,be).call(this)},a.onmessage=o=>{this.onMessage&&this.onMessage(o.data)},Q(this,G,a)})},this.reconnect=e=>{X(this,at,lt).call(this),this.connect(null,e)},this.disconnect=()=>{Q(this,K,!0),X(this,at,lt).call(this),x(this,G)&&(x(this,G).close(),Q(this,G,null))},this.sendText=e=>{if(!x(this,G)||x(this,G).readyState!=x(this,G).OPEN)throw new Error("Websocket is not connected");x(this,G).send(e)},this.isConnected=()=>x(this,G)&&x(this,G).readyState==x(this,G).OPEN}Pt.default=D;var ut={writable:!0,value:e=>{}};D.NETWORK_ERROR=503,D.NETWORK_ERROR_TEXT="Connection failed",D.NETWORK_USER=418,D.NETWORK_USER_TEXT="Disconnected by client";var Rt={};function we(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function Se(e,t,s){ve(e,t),t.set(e,s)}function ve(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Ee(e,t,s){return ye(e,t),function(i,n){if(i===void 0)throw new TypeError("attempted to get private static field before its declaration")}(s),Me(e,s)}function Te(e,t,s){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return s}function bt(e,t,s){return ye(e,t),s}function ye(e,t){if(e!==t)throw new TypeError("Private static access of wrong provenance")}function N(e,t){return Me(e,Ae(e,t,"get"))}function Me(e,t){return t.get?t.get.call(e):t.value}function Pe(e,t,s){return function(i,n,a){if(n.set)n.set.call(i,a);else{if(!n.writable)throw new TypeError("attempted to set read only private field");n.value=a}}(e,Ae(e,t,"set"),s),s}function Ae(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}let Wt;Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.default=void 0;var wt=new WeakMap,j=new WeakMap,Vt=new WeakSet;class U{constructor(t,s){var i;ve(this,i=Vt),i.add(this),Se(this,wt,{writable:!0,value:n=>{}}),Se(this,j,{writable:!0,value:n=>{}}),we(this,"db",null),we(this,"disabled",!1),Pe(this,wt,t||N(this,wt)),Pe(this,j,s||N(this,j))}initDatabase(){return new Promise((t,s)=>{const i=Wt.open("tinode-web",1);i.onsuccess=n=>{this.db=n.target.result,this.disabled=!1,t(this.db)},i.onerror=n=>{N(this,j).call(this,"PCache","failed to initialize",n),s(n.target.error),N(this,wt).call(this,n.target.error)},i.onupgradeneeded=n=>{this.db=n.target.result,this.db.onerror=a=>{N(this,j).call(this,"PCache","failed to create storage",a),N(this,wt).call(this,a.target.error)},this.db.createObjectStore("topic",{keyPath:"name"}),this.db.createObjectStore("user",{keyPath:"uid"}),this.db.createObjectStore("subscription",{keyPath:["topic","uid"]}),this.db.createObjectStore("message",{keyPath:["topic","seq"]})}})}deleteDatabase(){return this.db&&(this.db.close(),this.db=null),new Promise((t,s)=>{const i=Wt.deleteDatabase("tinode-web");i.onblocked=n=>{this.db&&this.db.close();const a=new Error("blocked");N(this,j).call(this,"PCache","deleteDatabase",a),s(a)},i.onsuccess=n=>{this.db=null,this.disabled=!0,t(!0)},i.onerror=n=>{N(this,j).call(this,"PCache","deleteDatabase",n.target.error),s(n.target.error)}})}isReady(){return!!this.db}updTopic(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["topic"],"readwrite");n.oncomplete=o=>{s(o.target.result)},n.onerror=o=>{N(this,j).call(this,"PCache","updTopic",o.target.error),i(o.target.error)};const a=n.objectStore("topic").get(t.name);a.onsuccess=o=>{n.objectStore("topic").put(bt(U,U,as).call(U,a.result,t)),n.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}markTopicAsDeleted(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["topic"],"readwrite");n.oncomplete=a=>{s(a.target.result)},n.onerror=a=>{N(this,j).call(this,"PCache","markTopicAsDeleted",a.target.error),i(a.target.error)},n.objectStore("topic").get(t).onsuccess=a=>{const o=a.target.result;o._deleted=!0,n.objectStore("topic").put(o),n.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remTopic(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["topic","subscription","message"],"readwrite");n.oncomplete=a=>{s(a.target.result)},n.onerror=a=>{N(this,j).call(this,"PCache","remTopic",a.target.error),i(a.target.error)},n.objectStore("topic").delete(IDBKeyRange.only(t)),n.objectStore("subscription").delete(IDBKeyRange.bound([t,"-"],[t,"~"])),n.objectStore("message").delete(IDBKeyRange.bound([t,0],[t,Number.MAX_SAFE_INTEGER])),n.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapTopics(t,s){return Te(this,Vt,Re).call(this,"topic",t,s)}deserializeTopic(t,s){bt(U,U,rs).call(U,t,s)}updUser(t,s){if(!(arguments.length<2||s===void 0))return this.isReady()?new Promise((i,n)=>{const a=this.db.transaction(["user"],"readwrite");a.oncomplete=o=>{i(o.target.result)},a.onerror=o=>{N(this,j).call(this,"PCache","updUser",o.target.error),n(o.target.error)},a.objectStore("user").put({uid:t,public:s}),a.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remUser(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["user"],"readwrite");n.oncomplete=a=>{s(a.target.result)},n.onerror=a=>{N(this,j).call(this,"PCache","remUser",a.target.error),i(a.target.error)},n.objectStore("user").delete(IDBKeyRange.only(t)),n.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapUsers(t,s){return Te(this,Vt,Re).call(this,"user",t,s)}getUser(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["user"]);n.oncomplete=a=>{const o=a.target.result;s({user:o.uid,public:o.public})},n.onerror=a=>{N(this,j).call(this,"PCache","getUser",a.target.error),i(a.target.error)},n.objectStore("user").get(t)}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}updSubscription(t,s,i){return this.isReady()?new Promise((n,a)=>{const o=this.db.transaction(["subscription"],"readwrite");o.oncomplete=l=>{n(l.target.result)},o.onerror=l=>{N(this,j).call(this,"PCache","updSubscription",l.target.error),a(l.target.error)},o.objectStore("subscription").get([t,s]).onsuccess=l=>{o.objectStore("subscription").put(bt(U,U,os).call(U,l.target.result,t,s,i)),o.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}mapSubscriptions(t,s,i){return this.isReady()?new Promise((n,a)=>{const o=this.db.transaction(["subscription"]);o.onerror=l=>{N(this,j).call(this,"PCache","mapSubscriptions",l.target.error),a(l.target.error)},o.objectStore("subscription").getAll(IDBKeyRange.bound([t,"-"],[t,"~"])).onsuccess=l=>{s&&l.target.result.forEach(b=>{s.call(i,b)}),n(l.target.result)}}):this.disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"))}addMessage(t){return this.isReady()?new Promise((s,i)=>{const n=this.db.transaction(["message"],"readwrite");n.onsuccess=a=>{s(a.target.result)},n.onerror=a=>{N(this,j).call(this,"PCache","addMessage",a.target.error),i(a.target.error)},n.objectStore("message").add(bt(U,U,xe).call(U,null,t)),n.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}updMessageStatus(t,s,i){return this.isReady()?new Promise((n,a)=>{const o=this.db.transaction(["message"],"readwrite");o.onsuccess=b=>{n(b.target.result)},o.onerror=b=>{N(this,j).call(this,"PCache","updMessageStatus",b.target.error),a(b.target.error)};const l=o.objectStore("message").get(IDBKeyRange.only([t,s]));l.onsuccess=b=>{const g=l.result||b.target.result;g&&g._status!=i&&o.objectStore("message").put(bt(U,U,xe).call(U,g,{topic:t,seq:s,_status:i})),o.commit()}}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}remMessages(t,s,i){return this.isReady()?new Promise((n,a)=>{s||i||(s=0,i=Number.MAX_SAFE_INTEGER);const o=i>0?IDBKeyRange.bound([t,s],[t,i],!1,!0):IDBKeyRange.only([t,s]),l=this.db.transaction(["message"],"readwrite");l.onsuccess=b=>{n(b.target.result)},l.onerror=b=>{N(this,j).call(this,"PCache","remMessages",b.target.error),a(b.target.error)},l.objectStore("message").delete(o),l.commit()}):this.disabled?Promise.resolve():Promise.reject(new Error("not initialized"))}readMessages(t,s,i,n){return this.isReady()?new Promise((a,o)=>{const l=(s=s||{}).since>0?s.since:0,b=s.before>0?s.before:Number.MAX_SAFE_INTEGER,g=0|s.limit,m=[],u=IDBKeyRange.bound([t,l],[t,b],!1,!0),v=this.db.transaction(["message"]);v.onerror=M=>{N(this,j).call(this,"PCache","readMessages",M.target.error),o(M.target.error)},v.objectStore("message").openCursor(u,"prev").onsuccess=M=>{const E=M.target.result;E?(i&&i.call(n,E.value),m.push(E.value),g<=0||m.length<g?E.continue():a(m)):a(m)}}):this.disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"))}static setDatabaseProvider(t){Wt=t}}function Re(e,t,s){return this.db?new Promise((i,n)=>{const a=this.db.transaction([e]);a.onerror=o=>{N(this,j).call(this,"PCache","mapObjects",e,o.target.error),n(o.target.error)},a.objectStore(e).getAll().onsuccess=o=>{t&&o.target.result.forEach(l=>{t.call(s,l)}),i(o.target.result)}}):disabled?Promise.resolve([]):Promise.reject(new Error("not initialized"))}function rs(e,t){Ee(U,U,Oe).forEach(s=>{t.hasOwnProperty(s)&&(e[s]=t[s])}),Array.isArray(t.tags)&&(e._tags=t.tags),t.acs&&e.setAccessMode(t.acs),e.seq|=0,e.read|=0,e.unread=Math.max(0,e.seq-e.read)}function as(e,t){const s=e||{name:t.name};return Ee(U,U,Oe).forEach(i=>{t.hasOwnProperty(i)&&(s[i]=t[i])}),Array.isArray(t._tags)&&(s.tags=t._tags),t.acs&&(s.acs=t.getAccessMode().jsonHelper()),s}function os(e,t,s,i){const n=e||{topic:t,uid:s};return["updated","mode","read","recv","clear","lastSeen","userAgent"].forEach(a=>{i.hasOwnProperty(a)&&(n[a]=i[a])}),n}function xe(e,t){const s=e||{};return["topic","seq","ts","_status","from","head","content"].forEach(i=>{t.hasOwnProperty(i)&&(s[i]=t[i])}),s}Rt.default=U;var Oe={writable:!0,value:["created","updated","deleted","read","recv","seq","clear","defacs","creds","public","trusted","private","touched","_deleted"]},St={exports:{}};const cs=["act","height","duration","incoming","mime","name","preview","ref","size","state","url","val","width"],hs=[{name:"ST",start:/(?:^|[\W_])(\*)[^\s*]/,end:/[^\s*](\*)(?=$|[\W_])/},{name:"EM",start:/(?:^|\W)(_)[^\s_]/,end:/[^\s_](_)(?=$|\W)/},{name:"DL",start:/(?:^|[\W_])(~)[^\s~]/,end:/[^\s~](~)(?=$|[\W_])/},{name:"CO",start:/(?:^|\W)(`)[^`]/,end:/[^`](`)(?=$|\W)/}],De=["QQ"],ls=[{name:"LN",dataName:"url",pack:function(e){return/^[a-z]+:\/\//i.test(e)||(e="http://"+e),{url:e}},re:/(?:(?:https?|ftp):\/\/|www\.|ftp\.)[-A-Z0-9+&@#\/%=~_|$?!:,.]*[A-Z0-9+&@#\/%=~_|$]/gi},{name:"MN",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B@([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu},{name:"HT",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B#([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu}],Ft={AU:{name:"audio",isVoid:!1},BN:{name:"button",isVoid:!1},BR:{name:"br",isVoid:!0},CO:{name:"tt",isVoid:!1},DL:{name:"del",isVoid:!1},EM:{name:"i",isVoid:!1},EX:{name:"",isVoid:!0},FM:{name:"div",isVoid:!1},HD:{name:"",isVoid:!1},HL:{name:"span",isVoid:!1},HT:{name:"a",isVoid:!1},IM:{name:"img",isVoid:!1},LN:{name:"a",isVoid:!1},MN:{name:"a",isVoid:!1},RW:{name:"div",isVoid:!1},QQ:{name:"div",isVoid:!1},ST:{name:"b",isVoid:!1},VC:{name:"div",isVoid:!1}};function dt(e,t,s){if(!e)return null;try{const i=atob(e),n=i.length,a=new ArrayBuffer(n),o=new Uint8Array(a);for(let l=0;l<n;l++)o[l]=i.charCodeAt(l);return URL.createObjectURL(new Blob([a],{type:t}))}catch(i){s&&s("Drafty: failed to convert object.",i.message)}return null}function Ce(e,t){return e?"data:"+(t=t||"image/jpeg")+";base64,"+e:null}const Ht={ST:{open:e=>"<b>",close:e=>"</b>"},EM:{open:e=>"<i>",close:e=>"</i>"},DL:{open:e=>"<del>",close:e=>"</del>"},CO:{open:e=>"<tt>",close:e=>"</tt>"},BR:{open:e=>"<br/>",close:e=>""},HD:{open:e=>"",close:e=>""},HL:{open:e=>'<span style="color:teal">',close:e=>"</span>"},LN:{open:e=>'<a href="'+e.url+'">',close:e=>"</a>",props:e=>e?{href:e.url,target:"_blank"}:null},MN:{open:e=>'<a href="#'+e.val+'">',close:e=>"</a>",props:e=>e?{id:e.val}:null},HT:{open:e=>'<a href="#'+e.val+'">',close:e=>"</a>",props:e=>e?{id:e.val}:null},BN:{open:e=>"<button>",close:e=>"</button>",props:e=>e?{"data-act":e.act,"data-val":e.val,"data-name":e.name,"data-ref":e.ref}:null},AU:{open:e=>'<audio controls src="'+(e.ref||dt(e.val,e.mime,S.logger))+'">',close:e=>"</audio>",props:e=>e?{src:e.ref||dt(e.val,e.mime,S.logger),"data-preload":e.ref?"metadata":"auto","data-duration":e.duration,"data-name":e.name,"data-size":e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}:null},IM:{open:e=>{const t=Ce(e._tempPreview,e.mime),s=dt(e.val,e.mime,S.logger),i=e.ref||s;return(e.name?'<a href="'+i+'" download="'+e.name+'">':"")+'<img src="'+(t||s)+'"'+(e.width?' width="'+e.width+'"':"")+(e.height?' height="'+e.height+'"':"")+' border="0" />'},close:e=>e.name?"</a>":"",props:e=>e?{src:Ce(e._tempPreview,e.mime)||e.ref||dt(e.val,e.mime,S.logger),title:e.name,alt:e.name,"data-width":e.width,"data-height":e.height,"data-name":e.name,"data-size":e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}:null},FM:{open:e=>"<div>",close:e=>"</div>"},RW:{open:e=>"<div>",close:e=>"</div>"},QQ:{open:e=>"<div>",close:e=>"</div>",props:e=>e?{}:null},VC:{open:e=>"<div>",close:e=>"</div>",props:e=>e?{"data-duration":e.duration,"data-state":e.state}:{}}},S=function(){this.txt="",this.fmt=[],this.ent=[]};function pt(e){if(!e)return null;e=typeof e=="string"?{txt:e}:e;let{txt:t,fmt:s,ent:i}=e;if(t=t||"",Array.isArray(i)||(i=[]),!Array.isArray(s)||s.length==0){if(i.length==0)return{text:t};s=[{at:0,len:0,key:0}]}const n=[],a=[];s.forEach(l=>{if(!l||typeof l!="object"||!["undefined","number"].includes(typeof l.at)||!["undefined","number"].includes(typeof l.len))return;let b=0|l.at,g=0|l.len;if(g<0)return;let m=l.key||0;i.length>0&&(typeof m!="number"||m<0||m>=i.length)||(b<=-1?a.push({start:-1,end:0,key:m}):b+g>t.length||(l.tp?n.push({type:l.tp,start:b,end:b+g}):i.length>0&&typeof i[m]=="object"&&n.push({start:b,end:b+g,key:m})))}),n.sort((l,b)=>{let g=l.start-b.start;return g!=0?g:(g=b.end-l.end,g!=0?g:De.indexOf(b.type)-De.indexOf(l.type))}),a.length>0&&n.push(...a),n.forEach(l=>{i.length>0&&!l.type&&i[l.key]&&typeof i[l.key]=="object"&&(l.type=i[l.key].tp,l.data=i[l.key].data),l.type||(l.type="HD")});let o=function l(b,g,m,u,v){if(!v||v.length==0)return m<u&&vt(b,{text:g.substring(m,u)}),b;for(let M=0;M<v.length;M++){const E=v[M];if(E.start<0&&E.type=="EX"){vt(b,{type:E.type,data:E.data,key:E.key,att:!0});continue}m<E.start&&(vt(b,{text:g.substring(m,E.start)}),m=E.start);const P=[];for(;M<v.length-1;){const C=v[M+1];if(C.start<0||!(C.start<E.end))break;if(C.end<=E.end){const I=Ft[C.tp]||{};(C.start<C.end||I.isVoid)&&P.push(C)}M++}vt(b,l({type:E.type,data:E.data,key:E.key},g,m,E.end,P)),m=E.end}return m<u&&vt(b,{text:g.substring(m,u)}),b}({},t,0,t.length,n);return o=ot(o,function(l){if(Array.isArray(l.children)&&l.children.length==1){const b=l.children[0];if(l.type)b.type||b.children||(l.text=b.text,delete l.children);else{const g=l.parent;(l=b).parent=g}}return l}),o}function vt(e,t){return t&&(e.children||(e.children=[]),e.text&&(e.children.push({text:e.text,parent:e}),delete e.text),t.parent=e,e.children.push(t)),e}function Et(e,t,s){if(!t)return e;e.txt=e.txt||"";const i=e.txt.length;if(t.text?e.txt+=t.text:Array.isArray(t.children)&&t.children.forEach(n=>{Et(e,n,s)}),t.type){const n=e.txt.length-i;if(e.fmt=e.fmt||[],Object.keys(t.data||{}).length>0){e.ent=e.ent||[];const a=s[t.key]===void 0?e.ent.length:s[t.key];s[t.key]=a,e.ent[a]={tp:t.type,data:t.data},t.att?e.fmt.push({at:-1,len:0,key:a}):e.fmt.push({at:i,len:n,key:a})}else e.fmt.push({tp:t.type,at:i,len:n})}return e}function ot(e,t,s){if(!e)return null;let i=t.call(s,e);if(!i||!i.children)return i;const n=[];for(let a in i.children){let o=i.children[a];o&&(o=ot(o,t,s),o&&n.push(o))}return n.length==0?i.children=null:i.children=n,i}function zt(e,t,s,i,n){if(!e)return null;i&&e.type&&i.push(e.type);let a=[];for(let o in e.children){const l=zt(e.children[o],t,o,i,n);l&&a.push(l)}return a.length==0&&(a=e.text?[e.text]:null),i&&e.type&&i.pop(),t.call(n,e.type,e.data,a,s,i)}function Bt(e,t,s){return e?(s&&(t-=s.length),ot(e,function(i){if(t<=-1)return null;if(i.att)return i;if(t==0)i.text=s,t=-1;else if(i.text){const n=i.text.length;n>t?(i.text=i.text.substring(0,t)+s,t=-1):t-=n}return i})):null}function xt(e,t){return ot(e,s=>{const i=Ne(s.data,!0,t?t(s):null);return i?s.data=i:delete s.data,s})}function Ie(e,t){if(!e)return null;if(e.att)e.text=" ",delete e.att,delete e.children;else if(e.children){const s=[],i=[];for(let n in e.children){const a=e.children[n];if(a.att){if(s.length==t||a.data.mime=="application/json")continue;delete a.att,delete a.children,a.text=" ",s.push(a)}else i.push(a)}e.children=i.concat(s)}return e}function Ne(e,t,s){if(e&&Object.entries(e).length>0){s=s||[];const i={};if(cs.forEach(n=>{if(e[n]){if(t&&!s.includes(n)&&(typeof e[n]=="string"||Array.isArray(e[n]))&&e[n].length>64||typeof e[n]=="object")return;i[n]=e[n]}}),Object.entries(i).length!=0)return i}return null}S.init=function(e){if(e===void 0)e="";else if(typeof e!="string")return null;return{txt:e}},S.parse=function(e){if(typeof e!="string")return null;const t=e.split(/\r?\n/),s=[],i={},n=[];t.forEach(o=>{let l,b,g=[];if(hs.forEach(m=>{g=g.concat(function(u,v,M,E){const P=[];let C=0,I=u.slice(0);for(;I.length>0;){const k=v.exec(I);if(k==null)break;let R=k.index+k[0].lastIndexOf(k[1]);I=I.slice(R+1),R+=C,C=R+1;const Y=M?M.exec(I):null;if(Y==null)break;let nt=Y.index+Y[0].indexOf(Y[1]);I=I.slice(nt+1),nt+=C,C=nt+1,P.push({txt:u.slice(R+1,nt),children:[],at:R,end:nt,tp:E})}return P}(o,m.start,m.end,m.name))}),g.length==0)b={txt:o};else{g.sort((u,v)=>{const M=u.at-v.at;return M!=0?M:v.end-u.end}),g=function u(v){if(v.length==0)return[];const M=[v[0]];let E=v[0];for(let P=1;P<v.length;P++)v[P].at>E.end?(M.push(v[P]),E=v[P]):v[P].end<=E.end&&E.children.push(v[P]);for(let P in M)M[P].children=u(M[P].children);return M}(g);const m=function u(v,M){let E="",P=[];for(let C in v){const I=v[C];if(!I.txt){const k=u(I.children,E.length+M);I.txt=k.txt,P=P.concat(k.fmt)}I.tp&&P.push({at:E.length+M,len:I.txt.length,tp:I.tp}),E+=I.txt}return{txt:E,fmt:P}}(function u(v,M,E,P){const C=[];if(P.length==0)return[];for(let I in P){const k=P[I];k.at>M&&C.push({txt:v.slice(M,k.at)});const R={tp:k.tp},Y=u(v,k.at+1,k.end,k.children);Y.length>0?R.children=Y:R.txt=k.txt,C.push(R),M=k.end+1}return M<E&&C.push({txt:v.slice(M,E)}),C}(o,0,o.length,g),0);b={txt:m.txt,fmt:m.fmt}}if(l=function(m){let u,v=[];if(ls.forEach(E=>{for(;(u=E.re.exec(m))!==null;)v.push({offset:u.index,len:u[0].length,unique:u[0],data:E.pack(u[0]),type:E.name})}),v.length==0)return v;v.sort((E,P)=>E.offset-P.offset);let M=-1;return v=v.filter(E=>{const P=E.offset>M;return M=E.offset+E.len,P}),v}(b.txt),l.length>0){const m=[];for(let u in l){const v=l[u];let M=i[v.unique];M||(M=s.length,i[v.unique]=M,s.push({tp:v.type,data:v.data})),m.push({at:v.offset,len:v.len,key:M})}b.ent=m}n.push(b)});const a={txt:""};if(n.length>0){a.txt=n[0].txt,a.fmt=(n[0].fmt||[]).concat(n[0].ent||[]);for(let o=1;o<n.length;o++){const l=n[o],b=a.txt.length+1;a.fmt.push({tp:"BR",len:1,at:b-1}),a.txt+=" "+l.txt,l.fmt&&(a.fmt=a.fmt.concat(l.fmt.map(g=>(g.at+=b,g)))),l.ent&&(a.fmt=a.fmt.concat(l.ent.map(g=>(g.at+=b,g))))}a.fmt.length==0&&delete a.fmt,s.length>0&&(a.ent=s)}return a},S.append=function(e,t){if(!e)return t;if(!t)return e;e.txt=e.txt||"";const s=e.txt.length;return typeof t=="string"?e.txt+=t:t.txt&&(e.txt+=t.txt),Array.isArray(t.fmt)&&(e.fmt=e.fmt||[],Array.isArray(t.ent)&&(e.ent=e.ent||[]),t.fmt.forEach(i=>{const n={at:(0|i.at)+s,len:0|i.len};i.at==-1&&(n.at=-1,n.len=0),i.tp?n.tp=i.tp:(n.key=e.ent.length,e.ent.push(t.ent[i.key||0])),e.fmt.push(n)})),e},S.insertImage=function(e,t,s){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const i={tp:"IM",data:{mime:s.mime,val:s.preview,width:s.width,height:s.height,name:s.filename,size:0|s.size,ref:s.refurl}};return s.urlPromise&&(i.data._tempPreview=s._tempPreview,i.data._processing=!0,s.urlPromise.then(n=>{i.data.ref=n,i.data._tempPreview=void 0,i.data._processing=void 0},n=>{i.data._processing=void 0})),e.ent.push(i),e},S.insertAudio=function(e,t,s){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const i={tp:"AU",data:{mime:s.mime,val:s.data,duration:0|s.duration,preview:s.preview,name:s.filename,size:0|s.size,ref:s.refurl}};return s.urlPromise&&(i.data._processing=!0,s.urlPromise.then(n=>{i.data.ref=n,i.data._processing=void 0},n=>{i.data._processing=void 0})),e.ent.push(i),e},S.videoCall=function(){return{txt:" ",fmt:[{at:0,len:1,key:0}],ent:[{tp:"VC"}]}},S.updateVideoEnt=function(e,t){const s=((e||{}).fmt||[])[0];if(!s)return e;let i;if(s.tp=="VC")delete s.tp,s.key=0,i={tp:"VC"},e.ent=[i];else if(i=(e.ent||[])[0|s.key],!i||i.tp!="VC")return e;return i.data=i.data||{},Object.assign(i.data,t),e},S.quote=function(e,t,s){const i=S.append(S.appendLineBreak(S.mention(e,t)),s);return i.fmt.push({at:0,len:i.txt.length,tp:"QQ"}),i},S.mention=function(e,t){return{txt:e||"",fmt:[{at:0,len:(e||"").length,key:0}],ent:[{tp:"MN",data:{val:t}}]}},S.appendLink=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:e.txt.length,len:t.txt.length,key:e.ent.length}),e.txt+=t.txt;const s={tp:"LN",data:{url:t.url}};return e.ent.push(s),e},S.appendImage=function(e,t){return(e=e||{txt:""}).txt+=" ",S.insertImage(e,e.txt.length-1,t)},S.appendAudio=function(e,t){return(e=e||{txt:""}).txt+=" ",S.insertAudio(e,e.txt.length-1,t)},S.attachFile=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length});const s={tp:"EX",data:{mime:t.mime,val:t.data,name:t.filename,ref:t.refurl,size:0|t.size}};return t.urlPromise&&(s.data._processing=!0,t.urlPromise.then(i=>{s.data.ref=i,s.data._processing=void 0},i=>{s.data._processing=void 0})),e.ent.push(s),e},S.wrapInto=function(e,t,s,i){return typeof e=="string"&&(e={txt:e}),e.fmt=e.fmt||[],e.fmt.push({at:s||0,len:i||e.txt.length,tp:t}),e},S.wrapAsForm=function(e,t,s){return S.wrapInto(e,"FM",t,s)},S.insertButton=function(e,t,s,i,n,a,o){return typeof e=="string"&&(e={txt:e}),!e||!e.txt||e.txt.length<t+s||s<=0||["url","pub"].indexOf(n)==-1?null:n!="url"||o?(o=""+o,e.ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:s,key:e.ent.length}),e.ent.push({tp:"BN",data:{act:n,val:a,ref:o,name:i}}),e):null},S.appendButton=function(e,t,s,i,n,a){const o=(e=e||{txt:""}).txt.length;return e.txt+=t,S.insertButton(e,o,t.length,s,i,n,a)},S.attachJSON=function(e,t){return(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length}),e.ent.push({tp:"EX",data:{mime:"application/json",val:t}}),e},S.appendLineBreak=function(e){return(e=e||{txt:""}).fmt=e.fmt||[],e.fmt.push({at:e.txt.length,len:1,tp:"BR"}),e.txt+=" ",e},S.UNSAFE_toHTML=function(e){return zt(pt(e),function(t,s,i){const n=Ht[t];let a=i?i.join(""):"";return n&&(a=n.open(s)+a+n.close(s)),a},0)},S.format=function(e,t,s){return zt(pt(e),t,0,[],s)},S.shorten=function(e,t,s){let i=pt(e);return i=Bt(i,t,"\u2026"),i&&s&&(i=xt(i)),Et({},i,[])},S.forwardedContent=function(e){let t=pt(e);return t=ot(t,function(s){return s.type!="MN"||s.parent&&s.parent.type?s:null}),t=function s(i){if(i.type=="BR")i=null;else if(i.text)i.type||(i.text=i.text.trimStart(),i.text||(i=null));else if(!i.type&&i.children&&i.children.length>0){const n=s(i.children[0]);n?i.children[0]=n:(i.children.shift(),i.type||i.children.length!=0||(i=null))}return i}(t),Et({},t,[])},S.replyContent=function(e,t){let s=pt(e);return s?(s=ot(s,function(i){return i.type=="QQ"?null:(i.type=="MN"?i.parent&&i.parent.type||!(i.text||"").startsWith("\u27A6")||(i.text="\u27A6",delete i.children,delete i.data):i.type=="BR"&&(i.text=" ",delete i.type,delete i.children),i)}),s=Ie(s,3),s=Bt(s,t,"\u2026"),s=xt(s,i=>i.type=="IM"?["val"]:null),Et({},s,[])):e},S.preview=function(e,t,s){let i=pt(e);return i=Ie(i,3),i=ot(i,function(n){return n.type=="MN"?n.parent&&n.parent.type||!(n.text||"").startsWith("\u27A6")||(n.text="\u27A6",delete n.children):n.type=="QQ"?(n.text=" ",delete n.children):n.type=="BR"&&(n.text=" ",delete n.children,delete n.type),n}),i=Bt(i,t,"\u2026"),i=s?xt(i,n=>n.type=="IM"?["val"]:null):xt(i),Et({},i,[])},S.toPlainText=function(e){return typeof e=="string"?e:e.txt},S.isPlainText=function(e){return typeof e=="string"||!(e.fmt||e.ent)},S.isValid=function(e){if(!e)return!1;const{txt:t,fmt:s,ent:i}=e;if(!t&&t!==""&&!s&&!i)return!1;const n=typeof t;return!(n!="string"&&n!="undefined"&&t!==null||s!==void 0&&!Array.isArray(s)&&s!==null||i!==void 0&&!Array.isArray(i)&&i!==null)},S.hasAttachments=function(e){if(!Array.isArray(e.fmt))return!1;for(let t in e.fmt){const s=e.fmt[t];if(s&&s.at<0){const i=e.ent[0|s.key];return i&&i.tp=="EX"&&i.data}}return!1},S.attachments=function(e,t,s){if(!Array.isArray(e.fmt))return;let i=0;e.fmt.forEach(n=>{if(n&&n.at<0){const a=e.ent[0|n.key];a&&a.tp=="EX"&&a.data&&t.call(s,a.data,i++,"EX")}})},S.hasEntities=function(e){return e.ent&&e.ent.length>0},S.entities=function(e,t,s){if(e.ent&&e.ent.length>0)for(let i in e.ent)e.ent[i]&&t.call(s,e.ent[i].data,i,e.ent[i].tp)},S.sanitizeEntities=function(e){if(e&&e.ent&&e.ent.length>0)for(let t in e.ent){const s=e.ent[t];if(s&&s.data){const i=Ne(s.data);i?e.ent[t].data=i:delete e.ent[t].data}}return e},S.getDownloadUrl=function(e){let t=null;return e.mime!="application/json"&&e.val?t=dt(e.val,e.mime,S.logger):typeof e.ref=="string"&&(t=e.ref),t},S.isProcessing=function(e){return!!e._processing},S.getPreviewUrl=function(e){return e.val?dt(e.val,e.mime,S.logger):null},S.getEntitySize=function(e){return e.size?e.size:e.val?.75*e.val.length|0:0},S.getEntityMimeType=function(e){return e.mime||"text/plain"},S.tagName=function(e){return Ft[e]&&Ft[e].name},S.attrValue=function(e,t){if(t&&Ht[e])return Ht[e].props(t)},S.getContentType=function(){return"text/x-drafty"},St.exports=S,St=St.exports;var Ot={};let Ue;Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.default=void 0,Ot.default=class{constructor(e,t){this._tinode=e,this._version=t,this._apiKey=e._apiKey,this._authToken=e.getAuthToken(),this._reqId=e.getNextUniqueId(),this.xhr=new Ue,this.toResolve=null,this.toReject=null,this.onProgress=null,this.onSuccess=null,this.onFailure=null}uploadWithBaseUrl(e,t,s,i,n,a){const o=this;let l=`/v${this._version}/file/u/`;if(e){let g=e;if(g.endsWith("/")&&(g=g.slice(0,-1)),!g.startsWith("http://")&&!g.startsWith("https://"))throw new Error(`Invalid base URL '${e}'`);l=g+l}this.xhr.open("POST",l,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this._authToken&&this.xhr.setRequestHeader("X-Tinode-Auth","Token "+this._authToken.token);const b=new Promise((g,m)=>{this.toResolve=g,this.toReject=m});this.onProgress=i,this.onSuccess=n,this.onFailure=a,this.xhr.upload.onprogress=g=>{g.lengthComputable&&o.onProgress&&o.onProgress(g.loaded/g.total)},this.xhr.onload=function(){let g;try{g=JSON.parse(this.response,A.jsonParseHelper)}catch{o._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.response),g={ctrl:{code:this.status,text:this.statusText}}}this.status>=200&&this.status<300?(o.toResolve&&o.toResolve(g.ctrl.params.url),o.onSuccess&&o.onSuccess(g.ctrl)):this.status>=400?(o.toReject&&o.toReject(new Error(`${g.ctrl.text} (${g.ctrl.code})`)),o.onFailure&&o.onFailure(g.ctrl)):o._tinode.logger("ERROR: Unexpected server response status",this.status,this.response)},this.xhr.onerror=function(g){o.toReject&&o.toReject(new Error("failed")),o.onFailure&&o.onFailure(null)},this.xhr.onabort=function(g){o.toReject&&o.toReject(new Error("upload cancelled by user")),o.onFailure&&o.onFailure(null)};try{const g=new FormData;g.append("file",t),g.set("id",this._reqId),s&&g.set("topic",s),this.xhr.send(g)}catch(g){this.toReject&&this.toReject(g),this.onFailure&&this.onFailure(null)}return b}upload(e,t,s,i,n){const a=(this._tinode._secure?"https://":"http://")+this._tinode._host;return this.uploadWithBaseUrl(a,e,t,s,i,n)}download(e,t,s,i,n){if(!(0,A.isUrlRelative)(e))return void(n&&n(`The URL '${e}' must be relative, not absolute`));if(!this._authToken)return void(n&&n("Must authenticate first"));const a=this;this.xhr.open("GET",e,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("X-Tinode-Auth","Token "+this._authToken.token),this.xhr.responseType="blob",this.onProgress=i,this.xhr.onprogress=function(l){a.onProgress&&a.onProgress(l.loaded)};const o=new Promise((l,b)=>{this.toResolve=l,this.toReject=b});this.xhr.onload=function(){if(this.status==200){const l=document.createElement("a");l.href=window.URL.createObjectURL(new Blob([this.response],{type:s})),l.style.display="none",l.setAttribute("download",t),document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(l.href),a.toResolve&&a.toResolve()}else if(this.status>=400&&a.toReject){const l=new FileReader;l.onload=function(){try{const b=JSON.parse(this.result,A.jsonParseHelper);a.toReject(new Error(`${b.ctrl.text} (${b.ctrl.code})`))}catch(b){a._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.result),a.toReject(b)}},l.readAsText(this.response)}},this.xhr.onerror=function(l){a.toReject&&a.toReject(new Error("failed"))},this.xhr.onabort=function(){a.toReject&&a.toReject(null)};try{this.xhr.send()}catch(l){this.toReject&&this.toReject(l)}return o}cancel(){this.xhr&&this.xhr.readyState<4&&this.xhr.abort()}getId(){return this._reqId}static setNetworkProvider(e){Ue=e}};var Tt={};function ke(e,t){(function(s,i){if(i.has(s))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.add(e)}function Qt(e,t,s){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return s}Object.defineProperty(Tt,"__esModule",{value:!0}),Tt.default=void 0;var Kt=new WeakSet,je=new WeakSet;function qe(){return this.topic.updated}function us(){return this.topic.isP2PType()?Qt(this,Kt,qe).call(this):this.topic._lastSubsUpdate}Tt.default=class{constructor(e){ke(this,je),ke(this,Kt),this.topic=e,this.what={}}withData(e,t,s){return this.what.data={since:e,before:t,limit:s},this}withLaterData(e){return this.withData(this.topic._maxSeq>0?this.topic._maxSeq+1:void 0,void 0,e)}withEarlierData(e){return this.withData(void 0,this.topic._minSeq>0?this.topic._minSeq:void 0,e)}withDesc(e){return this.what.desc={ims:e},this}withLaterDesc(){return this.withDesc(Qt(this,Kt,qe).call(this))}withSub(e,t,s){const i={ims:e,limit:t};return this.topic.getType()=="me"?i.topic=s:i.user=s,this.what.sub=i,this}withOneSub(e,t){return this.withSub(e,void 0,t)}withLaterOneSub(e){return this.withOneSub(this.topic._lastSubsUpdate,e)}withLaterSub(e){return this.withSub(Qt(this,je,us).call(this),e)}withTags(){return this.what.tags=!0,this}withCred(){return this.topic.getType()=="me"?this.what.cred=!0:this.topic._tinode.logger("ERROR: Invalid topic type for MetaGetBuilder:withCreds",this.topic.getType()),this}withDel(e,t){return(e||t)&&(this.what.del={since:e,limit:t}),this}withLaterDel(e){return this.withDel(this.topic._maxSeq>0?this.topic._maxDel+1:void 0,e)}extract(e){return this.what[e]}build(){const e=[];let t={};return["data","sub","desc","tags","cred","del"].forEach(s=>{this.what.hasOwnProperty(s)&&(e.push(s),Object.getOwnPropertyNames(this.what[s]).length>0&&(t[s]=this.what[s]))}),e.length>0?t.what=e.join(" "):t=void 0,t}};var Dt={};function Le(e,t){We(e,t),t.add(e)}function Ge(e,t,s){We(e,t),t.set(e,s)}function We(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Xt(e,t,s){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return s}function Ve(e,t){return function(s,i){return i.get?i.get.call(s):i.value}(e,He(e,t,"get"))}function Fe(e,t,s){return function(i,n,a){if(n.set)n.set.call(i,a);else{if(!n.writable)throw new TypeError("attempted to set read only private field");n.value=a}}(e,He(e,t,"set"),s),s}function He(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}Object.defineProperty(Dt,"__esModule",{value:!0}),Dt.default=void 0;var $t=new WeakMap,Jt=new WeakMap,Yt=new WeakSet,ze=new WeakSet;function Be(e,t,s){let i=0,n=t.length-1,a=0,o=0,l=!1;for(;i<=n;)if(a=(i+n)/2|0,o=Ve(this,$t).call(this,t[a],e),o<0)i=a+1;else{if(!(o>0)){l=!0;break}n=a-1}return l?{idx:a,exact:!0}:s?{idx:-1}:{idx:o<0?a+1:a}}function ds(e,t){const s=Xt(this,Yt,Be).call(this,e,t,!1),i=s.exact&&Ve(this,Jt)?1:0;return t.splice(s.idx,i,e),t}Dt.default=class{constructor(e,t){var s;Le(this,ze),Le(this,Yt),Ge(this,$t,{writable:!0,value:void 0}),Ge(this,Jt,{writable:!0,value:!1}),s=[],"buffer"in this?Object.defineProperty(this,"buffer",{value:s,enumerable:!0,configurable:!0,writable:!0}):this.buffer=s,Fe(this,$t,e||((i,n)=>i===n?0:i<n?-1:1)),Fe(this,Jt,t)}getAt(e){return this.buffer[e]}getLast(e){return e|=0,this.buffer.length>e?this.buffer[this.buffer.length-1-e]:void 0}put(){let e;e=arguments.length==1&&Array.isArray(arguments[0])?arguments[0]:arguments;for(let t in e)Xt(this,ze,ds).call(this,e[t],this.buffer)}delAt(e){e|=0;let t=this.buffer.splice(e,1);if(t&&t.length>0)return t[0]}delRange(e,t){return this.buffer.splice(e,t-e)}length(){return this.buffer.length}reset(){this.buffer=[]}forEach(e,t,s,i){t|=0,s=s||this.buffer.length;for(let n=t;n<s;n++)e.call(i,this.buffer[n],n>t?this.buffer[n-1]:void 0,n<s-1?this.buffer[n+1]:void 0,n)}find(e,t){const{idx:s}=Xt(this,Yt,Be).call(this,e,this.buffer,!t);return s}filter(e,t){let s=0;for(let i=0;i<this.buffer.length;i++)e.call(t,this.buffer[i],i)&&(this.buffer[s]=this.buffer[i],s++);this.buffer.splice(s)}};var q={};Object.defineProperty(q,"__esModule",{value:!0}),q.TopicMe=q.TopicFnd=q.Topic=void 0;var Z=It(tt),Qe=It(Dt),T=function(e,t){if(e&&e.__esModule)return e;if(e===null||typeof e!="object"&&typeof e!="function")return{default:e};var s=function(l){if(typeof WeakMap!="function")return null;var b=new WeakMap,g=new WeakMap;return function(m){return m?g:b}(l)}(void 0);if(s&&s.has(e))return s.get(e);var i={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if(a!=="default"&&Object.prototype.hasOwnProperty.call(e,a)){var o=n?Object.getOwnPropertyDescriptor(e,a):null;o&&(o.get||o.set)?Object.defineProperty(i,a,o):i[a]=e[a]}return i.default=e,s&&s.set(e,i),i}(w),Ct=It(St),ps=It(Tt);function It(e){return e&&e.__esModule?e:{default:e}}function Ke(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class H{constructor(t,s){this._tinode=null,this.name=t,this.created=null,this.updated=null,this.touched=new Date(0),this.acs=new Z.default(null),this.private=null,this.public=null,this.trusted=null,this._users={},this._queuedSeqId=T.LOCAL_SEQID,this._maxSeq=0,this._minSeq=0,this._noEarlierMsgs=!1,this._maxDel=0,this._recvNotificationTimer=null,this._tags=[],this._credentials=[],this._messageVersions={},this._messages=new Qe.default((i,n)=>i.seq-n.seq,!0),this._attached=!1,this._lastSubsUpdate=new Date(0),this._new=!0,this._deleted=!1,this._delayedLeaveTimer=null,s&&(this.onData=s.onData,this.onMeta=s.onMeta,this.onPres=s.onPres,this.onInfo=s.onInfo,this.onMetaDesc=s.onMetaDesc,this.onMetaSub=s.onMetaSub,this.onSubsUpdated=s.onSubsUpdated,this.onTagsUpdated=s.onTagsUpdated,this.onCredsUpdated=s.onCredsUpdated,this.onDeleteTopic=s.onDeleteTopic,this.onAllMessagesReceived=s.onAllMessagesReceived)}static topicType(t){return{me:T.TOPIC_ME,fnd:T.TOPIC_FND,grp:T.TOPIC_GRP,new:T.TOPIC_GRP,nch:T.TOPIC_GRP,chn:T.TOPIC_GRP,usr:T.TOPIC_P2P,sys:T.TOPIC_SYS}[typeof t=="string"?t.substring(0,3):"xxx"]}static isMeTopicName(t){return H.topicType(t)==T.TOPIC_ME}static isGroupTopicName(t){return H.topicType(t)==T.TOPIC_GRP}static isP2PTopicName(t){return H.topicType(t)==T.TOPIC_P2P}static isCommTopicName(t){return H.isP2PTopicName(t)||H.isGroupTopicName(t)}static isNewGroupTopicName(t){return typeof t=="string"&&(t.substring(0,3)==T.TOPIC_NEW||t.substring(0,3)==T.TOPIC_NEW_CHAN)}static isChannelTopicName(t){return typeof t=="string"&&(t.substring(0,3)==T.TOPIC_CHAN||t.substring(0,3)==T.TOPIC_NEW_CHAN)}isSubscribed(){return this._attached}subscribe(t,s){return clearTimeout(this._delayedLeaveTimer),this._delayedLeaveTimer=null,this._attached?Promise.resolve(this):this._deleted?Promise.reject(new Error("Conversation deleted")):this._tinode.subscribe(this.name||T.TOPIC_NEW,t,s).then(i=>{if(i.code>=300)return i;if(this._attached=!0,this._deleted=!1,this.acs=i.params&&i.params.acs?i.params.acs:this.acs,this._new){if(delete this._new,this.name!=i.topic&&(this._cacheDelSelf(),this.name=i.topic),this._cachePutSelf(),this.created=i.ts,this.updated=i.ts,this.name!=T.TOPIC_ME&&this.name!=T.TOPIC_FND){const n=this._tinode.getMeTopic();n.onMetaSub&&n.onMetaSub(this),n.onSubsUpdated&&n.onSubsUpdated([this.name],1)}s&&s.desc&&(s.desc._noForwarding=!0,this._processMetaDesc(s.desc))}return i})}createMessage(t,s){return this._tinode.createMessage(this.name,t,s)}publish(t,s){return this.publishMessage(this.createMessage(t,s))}publishMessage(t){if(!this._attached)return Promise.reject(new Error("Cannot publish on inactive topic"));if(this._sending)return Promise.reject(new Error("The message is already being sent"));t._sending=!0,t._failed=!1;let s=null;return Ct.default.hasEntities(t.content)&&(s=[],Ct.default.entities(t.content,i=>{i&&i.ref&&s.push(i.ref)}),s.length==0&&(s=null)),this._tinode.publishMessage(t,s).then(i=>(t._sending=!1,t.ts=i.ts,this.swapMessageId(t,i.params.seq),this._routeData(t),i)).catch(i=>{this._tinode.logger("WARNING: Message rejected by the server",i),t._sending=!1,t._failed=!0,this.onData&&this.onData()})}publishDraft(t,s){const i=t.seq||this._getQueuedSeqId();return t._noForwarding||(t._noForwarding=!0,t.seq=i,t.ts=new Date,t.from=this._tinode.getCurrentUserID(),t.noecho=!0,this._messages.put(t),this._tinode._db.addMessage(t),this.onData&&this.onData(t)),(s||Promise.resolve()).then(n=>t._cancelled?{code:300,text:"cancelled"}:this.publishMessage(t)).catch(n=>{throw this._tinode.logger("WARNING: Message draft rejected",n),t._sending=!1,t._failed=!0,this.onData&&this.onData(),n})}leave(t){return this._attached||t?this._tinode.leave(this.name,t).then(s=>(this._resetSub(),t&&this._gone(),s)):Promise.reject(new Error("Cannot leave inactive topic"))}leaveDelayed(t,s){clearTimeout(this._delayedLeaveTimer),this._delayedLeaveTimer=setTimeout(i=>{this._delayedLeaveTimer=null,this.leave(t)},s)}getMeta(t){return this._tinode.getMeta(this.name,t)}getMessagesPage(t,s){let i=s?this.startMetaQuery().withLaterData(t):this.startMetaQuery().withEarlierData(t);return this._loadMessages(this._tinode._db,i.extract("data")).then(n=>{if(n==t)return Promise.resolve({topic:this.name,code:200,params:{count:n}});t-=n,i=s?this.startMetaQuery().withLaterData(t):this.startMetaQuery().withEarlierData(t);let a=this.getMeta(i.build());return s||(a=a.then(o=>{o&&o.params&&!o.params.count&&(this._noEarlierMsgs=!0)})),a})}setMeta(t){return t.tags&&(t.tags=(0,A.normalizeArray)(t.tags)),this._tinode.setMeta(this.name,t).then(s=>(s&&s.code>=300||(t.sub&&(t.sub.topic=this.name,s.params&&s.params.acs&&(t.sub.acs=s.params.acs,t.sub.updated=s.ts),t.sub.user||(t.sub.user=this._tinode.getCurrentUserID(),t.desc||(t.desc={})),t.sub._noForwarding=!0,this._processMetaSub([t.sub])),t.desc&&(s.params&&s.params.acs&&(t.desc.acs=s.params.acs,t.desc.updated=s.ts),this._processMetaDesc(t.desc)),t.tags&&this._processMetaTags(t.tags),t.cred&&this._processMetaCreds([t.cred],!0)),s))}updateMode(t,s){const i=t?this.subscriber(t):null,n=i?i.acs.updateGiven(s).getGiven():this.getAccessMode().updateWant(s).getWant();return this.setMeta({sub:{user:t,mode:n}})}invite(t,s){return this.setMeta({sub:{user:t,mode:s}})}archive(t){return this.private&&!this.private.arch==!t?Promise.resolve(t):this.setMeta({desc:{private:{arch:!!t||T.DEL_CHAR}}})}delMessages(t,s){if(!this._attached)return Promise.reject(new Error("Cannot delete messages in inactive topic"));t.sort((a,o)=>a.low<o.low||a.low==o.low&&(!o.hi||a.hi>=o.hi));let i,n=t.reduce((a,o)=>(o.low<T.LOCAL_SEQID&&(!o.hi||o.hi<T.LOCAL_SEQID?a.push(o):a.push({low:o.low,hi:this._maxSeq+1})),a),[]);return i=n.length>0?this._tinode.delMessages(this.name,n,s):Promise.resolve({params:{del:0}}),i.then(a=>(a.params.del>this._maxDel&&(this._maxDel=a.params.del),t.forEach(o=>{o.hi?this.flushMessageRange(o.low,o.hi):this.flushMessage(o.low)}),this._updateDeletedRanges(),this.onData&&this.onData(),a))}delMessagesAll(t){return!this._maxSeq||this._maxSeq<=0?Promise.resolve():this.delMessages([{low:1,hi:this._maxSeq+1,_all:!0}],t)}delMessagesList(t,s){t.sort((n,a)=>n-a);let i=t.reduce((n,a)=>{if(n.length==0)n.push({low:a});else{let o=n[n.length-1];!o.hi&&a!=o.low+1||a>o.hi?n.push({low:a}):o.hi=o.hi?Math.max(o.hi,a+1):a+1}return n},[]);return this.delMessages(i,s)}delTopic(t){return this._deleted?(this._gone(),Promise.resolve(null)):this._tinode.delTopic(this.name,t).then(s=>(this._deleted=!0,this._resetSub(),this._gone(),s))}delSubscription(t){return this._attached?this._tinode.delSubscription(this.name,t).then(s=>(delete this._users[t],this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users)),s)):Promise.reject(new Error("Cannot delete subscription in inactive topic"))}note(t,s){if(!this._attached)return;const i=this._users[this._tinode.getCurrentUserID()];let n=!1;i?(!i[t]||i[t]<s)&&(i[t]=s,n=!0):n=(0|this[t])<s,n&&(this._tinode.note(this.name,t,s),this._updateReadRecv(t,s),this.acs!=null&&!this.acs.isMuted())&&this._tinode.getMeTopic()._refreshContact(t,this)}noteRecv(t){this.note("recv",t)}noteRead(t){(t=t||this._maxSeq)>0&&this.note("read",t)}noteKeyPress(){this._attached?this._tinode.noteKeyPress(this.name):this._tinode.logger("INFO: Cannot send notification in inactive topic")}videoCall(t,s,i){if(this._attached||["ringing","hang-up"].includes(t))return this._tinode.videoCall(this.name,s,t,i)}_updateReadRecv(t,s,i){let n,a=!1;switch(s|=0,this.seq=0|this.seq,this.read=0|this.read,this.recv=0|this.recv,t){case"recv":n=this.recv,this.recv=Math.max(this.recv,s),a=n!=this.recv;break;case"read":n=this.read,this.read=Math.max(this.read,s),a=n!=this.read;break;case"msg":n=this.seq,this.seq=Math.max(this.seq,s),(!this.touched||this.touched<i)&&(this.touched=i),a=n!=this.seq}return this.recv<this.read&&(this.recv=this.read,a=!0),this.seq<this.recv&&(this.seq=this.recv,(!this.touched||this.touched<i)&&(this.touched=i),a=!0),this.unread=this.seq-this.read,a}userDesc(t){const s=this._cacheGetUser(t);if(s)return s}p2pPeerDesc(){if(this.isP2PType())return this._users[this.name]}subscribers(t,s){const i=t||this.onMetaSub;if(i)for(let n in this._users)i.call(s,this._users[n],n,this._users)}tags(){return this._tags.slice(0)}subscriber(t){return this._users[t]}messageVersions(t,s,i){if(!s)return;const n=this._isReplacementMsg(t)?parseInt(t.head.replace.split(":")[1]):t.seq,a=this._messageVersions[n];a&&a.forEach(s,void 0,void 0,i)}messages(t,s,i,n){const a=t||this.onData;if(a){const o=typeof s=="number"?this._messages.find({seq:s},!0):void 0,l=typeof i=="number"?this._messages.find({seq:i},!0):void 0;if(o!=-1&&l!=-1){let b=[];this._messages.forEach((g,m,u,v)=>{this._isReplacementMsg(g)||b.push({data:this.latestMsgVersion(g.seq)||g,idx:v})},o,l,{}),b.forEach((g,m)=>{a.call(n,g.data,m>0?b[m-1].data:void 0,m<b.length-1?b[m+1].data:void 0,g.idx)})}}}findMessage(t){const s=this._messages.find({seq:t});if(s>=0)return this._messages.getAt(s)}latestMessage(t){const s=this._messages.getLast();return t&&s&&s._status==T.MESSAGE_STATUS_DEL_RANGE?this._messages.getLast(1):s}latestMsgVersion(t){const s=this._messageVersions[t];return s?s.getLast():null}maxMsgSeq(){return this._maxSeq}maxClearId(){return this._maxDel}messageCount(){return this._messages.length()}queuedMessages(t,s){if(!t)throw new Error("Callback must be provided");this.messages(t,T.LOCAL_SEQID,void 0,s)}msgReceiptCount(t,s){let i=0;if(s>0){const n=this._tinode.getCurrentUserID();for(let a in this._users){const o=this._users[a];o.user!==n&&o[t]>=s&&i++}}return i}msgReadCount(t){return this.msgReceiptCount("read",t)}msgRecvCount(t){return this.msgReceiptCount("recv",t)}msgHasMoreMessages(t){return t?this.seq>this._maxSeq:this._minSeq>1&&!this._noEarlierMsgs}isNewMessage(t){return this._maxSeq<=t}flushMessage(t){const s=this._messages.find({seq:t});if(s>=0)return this._tinode._db.remMessages(this.name,t),this._messages.delAt(s)}swapMessageId(t,s){const i=this._messages.find(t),n=this._messages.length();0<=i&&i<n&&(this._messages.delAt(i),this._tinode._db.remMessages(this.name,t.seq),t.seq=s,this._messages.put(t),this._tinode._db.addMessage(t))}flushMessageRange(t,s){this._tinode._db.remMessages(this.name,t,s);const i=this._messages.find({seq:t},!0);return i>=0?this._messages.delRange(i,this._messages.find({seq:s},!0)):[]}cancelSend(t){const s=this._messages.find({seq:t});if(s>=0){const i=this._messages.getAt(s),n=this.msgStatus(i);if(n==T.MESSAGE_STATUS_QUEUED||n==T.MESSAGE_STATUS_FAILED)return this._tinode._db.remMessages(this.name,t),i._cancelled=!0,this._messages.delAt(s),this.onData&&this.onData(),!0}return!1}getType(){return H.topicType(this.name)}getAccessMode(){return this.acs}setAccessMode(t){return this.acs=new Z.default(t)}getDefaultAccess(){return this.defacs}startMetaQuery(){return new ps.default(this)}isArchived(){return this.private&&!!this.private.arch}isMeType(){return H.isMeTopicName(this.name)}isChannelType(){return H.isChannelTopicName(this.name)}isGroupType(){return H.isGroupTopicName(this.name)}isP2PType(){return H.isP2PTopicName(this.name)}isCommType(){return H.isCommTopicName(this.name)}msgStatus(t,s){let i=T.MESSAGE_STATUS_NONE;return this._tinode.isMe(t.from)?t._sending?i=T.MESSAGE_STATUS_SENDING:t._failed||t._cancelled?i=T.MESSAGE_STATUS_FAILED:t.seq>=T.LOCAL_SEQID?i=T.MESSAGE_STATUS_QUEUED:this.msgReadCount(t.seq)>0?i=T.MESSAGE_STATUS_READ:this.msgRecvCount(t.seq)>0?i=T.MESSAGE_STATUS_RECEIVED:t.seq>0&&(i=T.MESSAGE_STATUS_SENT):t._status==T.MESSAGE_STATUS_DEL_RANGE?T.MESSAGE_STATUS_DEL_RANGE:i=T.MESSAGE_STATUS_TO_ME,s&&t._status!=i&&(t._status=i,this._tinode._db.updMessageStatus(this.name,t.seq,i)),i}_isReplacementMsg(t){return t.head&&t.head.replace}_maybeUpdateMessageVersionsCache(t){if(!this._isReplacementMsg(t))return;const s=parseInt(t.head.replace.split(":")[1]);if(s>t.seq)return!1;let i=this._messageVersions[s]||new Qe.default((n,a)=>n.seq-a.seq,!0);i.put(t),this._messageVersions[s]=i}_routeData(t){t.content&&(!this.touched||this.touched<t.ts)&&(this.touched=t.ts,this._tinode._db.updTopic(this)),t.seq>this._maxSeq&&(this._maxSeq=t.seq,this.msgStatus(t,!0),clearTimeout(this._recvNotificationTimer),this._recvNotificationTimer=setTimeout(n=>{this._recvNotificationTimer=null,this.noteRecv(this._maxSeq)},T.RECV_TIMEOUT)),(t.seq<this._minSeq||this._minSeq==0)&&(this._minSeq=t.seq);const s=!this.isChannelType()&&!t.from||this._tinode.isMe(t.from);t.head&&t.head.webrtc&&t.head.mime==Ct.default.getContentType()&&t.content&&(t.content=Ct.default.updateVideoEnt(t.content,{state:t.head.webrtc,duration:t.head["webrtc-duration"],incoming:!s})),t._noForwarding||(this._messages.put(t),this._tinode._db.addMessage(t),this._maybeUpdateMessageVersionsCache(t),this._updateDeletedRanges()),this.onData&&this.onData(t);const i=s?"read":"msg";this._updateReadRecv(i,t.seq,t.ts),this._tinode.getMeTopic()._refreshContact(i,this)}_routeMeta(t){t.desc&&this._processMetaDesc(t.desc),t.sub&&t.sub.length>0&&this._processMetaSub(t.sub),t.del&&this._processDelMessages(t.del.clear,t.del.delseq),t.tags&&this._processMetaTags(t.tags),t.cred&&this._processMetaCreds(t.cred),this.onMeta&&this.onMeta(t)}_routePres(t){let s,i;switch(t.what){case"del":this._processDelMessages(t.clear,t.delseq);break;case"on":case"off":s=this._users[t.src],s?s.online=t.what=="on":this._tinode.logger("WARNING: Presence update for an unknown user",this.name,t.src);break;case"term":this._resetSub();break;case"upd":t.src&&!this._tinode.isTopicCached(t.src)&&this.getMeta(this.startMetaQuery().withLaterOneSub(t.src).build());break;case"acs":if(i=t.src||this._tinode.getCurrentUserID(),s=this._users[i],s)s.acs.updateAll(t.dacs),this._processMetaSub([{user:i,updated:new Date,acs:s.acs}]);else{const n=new Z.default().updateAll(t.dacs);n&&n.mode!=Z.default._NONE&&(s=this._cacheGetUser(i),s?s.acs=n:(s={user:i,acs:n},this.getMeta(this.startMetaQuery().withOneSub(void 0,i).build())),s.updated=new Date,this._processMetaSub([s]))}break;default:this._tinode.logger("INFO: Ignored presence update",t.what)}this.onPres&&this.onPres(t)}_routeInfo(t){switch(t.what){case"recv":case"read":const s=this._users[t.from];s&&(s[t.what]=t.seq,s.recv<s.read&&(s.recv=s.read));const i=this.latestMessage();i&&this.msgStatus(i,!0),this._tinode.isMe(t.from)&&this._updateReadRecv(t.what,t.seq),this._tinode.getMeTopic()._refreshContact(t.what,this);break;case"kp":case"call":break;default:this._tinode.logger("INFO: Ignored info update",t.what)}this.onInfo&&this.onInfo(t)}_processMetaDesc(t){if(this.isP2PType()&&(delete t.defacs,this._tinode._db.updUser(this.name,t.public)),(0,A.mergeObj)(this,t),this._tinode._db.updTopic(this),this.name!==T.TOPIC_ME&&!t._noForwarding){const s=this._tinode.getMeTopic();s.onMetaSub&&s.onMetaSub(this),s.onSubsUpdated&&s.onSubsUpdated([this.name],1)}this.onMetaDesc&&this.onMetaDesc(this)}_processMetaSub(t){for(let s in t){const i=t[s];i.online=!!i.online,this._lastSubsUpdate=new Date(Math.max(this._lastSubsUpdate,i.updated));let n=null;i.deleted?(delete this._users[i.user],n=i):(this._tinode.isMe(i.user)&&i.acs&&this._processMetaDesc({updated:i.updated,touched:i.touched,acs:i.acs}),n=this._updateCachedUser(i.user,i)),this.onMetaSub&&this.onMetaSub(n)}this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users))}_processMetaTags(t){t.length==1&&t[0]==T.DEL_CHAR&&(t=[]),this._tags=t,this.onTagsUpdated&&this.onTagsUpdated(t)}_processMetaCreds(t){}_processDelMessages(t,s){this._maxDel=Math.max(t,this._maxDel),this.clear=Math.max(t,this.clear);const i=this;let n=0;Array.isArray(s)&&s.forEach(function(a){if(a.hi)for(let o=a.low;o<a.hi;o++)n++,i.flushMessage(o);else n++,i.flushMessage(a.low)}),n>0&&(this._updateDeletedRanges(),this.onData&&this.onData())}_allMessagesReceived(t){this._updateDeletedRanges(),this.onAllMessagesReceived&&this.onAllMessagesReceived(t)}_resetSub(){this._attached=!1}_gone(){this._messages.reset(),this._tinode._db.remMessages(this.name),this._users={},this.acs=new Z.default(null),this.private=null,this.public=null,this.trusted=null,this._maxSeq=0,this._minSeq=0,this._attached=!1;const t=this._tinode.getMeTopic();t&&t._routePres({_noForwarding:!0,what:"gone",topic:T.TOPIC_ME,src:this.name}),this.onDeleteTopic&&this.onDeleteTopic()}_updateCachedUser(t,s){let i=this._cacheGetUser(t);return i=(0,A.mergeObj)(i||{},s),this._cachePutUser(t,i),(0,A.mergeToCache)(this._users,t,i)}_getQueuedSeqId(){return this._queuedSeqId++}_updateDeletedRanges(){const t=[];let s=null;const i=this._messages.getAt(0);i&&this._minSeq>1&&!this._noEarlierMsgs?i.hi?(i.seq>1&&(i.seq=1),i.hi<this._minSeq-1&&(i.hi=this._minSeq-1),s=i):(s={seq:1,hi:this._minSeq-1},t.push(s)):s={seq:0,hi:0},this._messages.filter(o=>o.seq>=T.LOCAL_SEQID||(o.seq==(s.hi||s.seq)+1?o.hi&&s.hi?(s.hi=o.hi,!1):(s=o,!0):(s.hi?s.hi=o.hi||o.seq:(s={seq:s.seq+1,hi:o.hi||o.seq},t.push(s)),!o.hi&&(s=o,!0))));const n=this._messages.getLast(),a=Math.max(this.seq,this._maxSeq)||0;(a>0&&!n||n&&(n.hi||n.seq)<a)&&(n&&n.hi?n.hi=a:t.push({seq:n?n.seq+1:1,hi:a})),t.forEach(o=>{o._status=T.MESSAGE_STATUS_DEL_RANGE,this._messages.put(o)})}_loadMessages(t,s){const{since:i,before:n,limit:a}=s||{};return t.readMessages(this.name,{since:i,before:n,limit:a||T.DEFAULT_MESSAGES_PAGE}).then(o=>(o.forEach(l=>{l.seq>this._maxSeq&&(this._maxSeq=l.seq),(l.seq<this._minSeq||this._minSeq==0)&&(this._minSeq=l.seq),this._messages.put(l),this._maybeUpdateMessageVersionsCache(l)}),o.length>0&&this._updateDeletedRanges(),o.length))}_updateReceived(t,s){this.touched=new Date,this.seq=0|t,s&&!this._tinode.isMe(s)||(this.read=this.read?Math.max(this.read,this.seq):this.seq,this.recv=this.recv?Math.max(this.read,this.recv):this.read),this.unread=this.seq-(0|this.read),this._tinode._db.updTopic(this)}}q.Topic=H,q.TopicMe=class extends H{constructor(e){super(T.TOPIC_ME,e),Ke(this,"onContactUpdate",void 0),e&&(this.onContactUpdate=e.onContactUpdate)}_processMetaDesc(e){const t=e.acs&&!e.acs.isPresencer()&&this.acs&&this.acs.isPresencer();(0,A.mergeObj)(this,e),this._tinode._db.updTopic(this),this._updateCachedUser(this._tinode._myUID,e),t&&this._tinode.mapTopics(s=>{s.online&&(s.online=!1,s.seen=Object.assign(s.seen||{},{when:new Date}),this._refreshContact("off",s))}),this.onMetaDesc&&this.onMetaDesc(this)}_processMetaSub(e){let t=0;if(e.forEach(s=>{const i=s.topic;if(i==T.TOPIC_FND||i==T.TOPIC_ME)return;s.online=!!s.online;let n=null;if(s.deleted)n=s,this._tinode.cacheRemTopic(i),this._tinode._db.remTopic(i);else{s.seq!==void 0&&(s.seq=0|s.seq,s.recv=0|s.recv,s.read=0|s.read,s.unread=s.seq-s.read);const a=this._tinode.getTopic(i);a._new&&delete a._new,n=(0,A.mergeObj)(a,s),this._tinode._db.updTopic(n),H.isP2PTopicName(i)&&(this._cachePutUser(i,n),this._tinode._db.updUser(i,n.public)),!s._noForwarding&&a&&(s._noForwarding=!0,a._processMetaDesc(s))}t++,this.onMetaSub&&this.onMetaSub(n)}),this.onSubsUpdated&&t>0){const s=[];e.forEach(i=>{s.push(i.topic)}),this.onSubsUpdated(s,t)}}_processMetaCreds(e,t){e.length==1&&e[0]==T.DEL_CHAR&&(e=[]),t?e.forEach(s=>{if(s.val){let i=this._credentials.findIndex(n=>n.meth==s.meth&&n.val==s.val);i<0?(s.done||(i=this._credentials.findIndex(n=>n.meth==s.meth&&!n.done),i>=0&&this._credentials.splice(i,1)),this._credentials.push(s)):this._credentials[i].done=s.done}else if(s.resp){const i=this._credentials.findIndex(n=>n.meth==s.meth&&!n.done);i>=0&&(this._credentials[i].done=!0)}}):this._credentials=e,this.onCredsUpdated&&this.onCredsUpdated(this._credentials)}_routePres(e){if(e.what=="term")return void this._resetSub();if(e.what=="upd"&&e.src==T.TOPIC_ME)return void this.getMeta(this.startMetaQuery().withDesc().build());const t=this._tinode.cacheGetTopic(e.src);if(t){switch(e.what){case"on":t.online=!0;break;case"off":t.online&&(t.online=!1,t.seen=Object.assign(t.seen||{},{when:new Date}));break;case"msg":t._updateReceived(e.seq,e.act);break;case"upd":this.getMeta(this.startMetaQuery().withLaterOneSub(e.src).build());break;case"acs":t.acs?t.acs.updateAll(e.dacs):t.acs=new Z.default().updateAll(e.dacs),t.touched=new Date;break;case"ua":t.seen={when:new Date,ua:e.ua};break;case"recv":e.seq=0|e.seq,t.recv=t.recv?Math.max(t.recv,e.seq):e.seq;break;case"read":e.seq=0|e.seq,t.read=t.read?Math.max(t.read,e.seq):e.seq,t.recv=t.recv?Math.max(t.read,t.recv):t.recv,t.unread=t.seq-t.read;break;case"gone":t._deleted?this._tinode._db.remTopic(e.src):(t._deleted=!0,t._attached=!1,this._tinode._db.markTopicAsDeleted(e.src));break;case"del":break;default:this._tinode.logger("INFO: Unsupported presence update in 'me'",e.what)}this._refreshContact(e.what,t)}else if(e.what=="acs"){const s=new Z.default(e.dacs);if(!s||s.mode==Z.default._INVALID)return void this._tinode.logger("ERROR: Invalid access mode update",e.src,e.dacs);if(s.mode==Z.default._NONE)return void this._tinode.logger("WARNING: Removing non-existent subscription",e.src,e.dacs);{this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build());const i=this._tinode.getTopic(e.src);i.topic=e.src,i.online=!1,i.acs=s,this._tinode._db.updTopic(i)}}else e.what=="tags"&&this.getMeta(this.startMetaQuery().withTags().build());this.onPres&&this.onPres(e)}_refreshContact(e,t){this.onContactUpdate&&this.onContactUpdate(e,t)}publish(){return Promise.reject(new Error("Publishing to 'me' is not supported"))}delCredential(e,t){return this._attached?this._tinode.delCredential(e,t).then(s=>{const i=this._credentials.findIndex(n=>n.meth==e&&n.val==t);return i>-1&&this._credentials.splice(i,1),this.onCredsUpdated&&this.onCredsUpdated(this._credentials),s}):Promise.reject(new Error("Cannot delete credential in inactive 'me' topic"))}contacts(e,t,s){this._tinode.mapTopics((i,n)=>{!i.isCommType()||t&&!t(i)||e.call(s,i,n)})}getContact(e){return this._tinode.cacheGetTopic(e)}getAccessMode(e){if(e){const t=this._tinode.cacheGetTopic(e);return t?t.acs:null}return this.acs}isArchived(e){const t=this._tinode.cacheGetTopic(e);return t&&t.private&&!!t.private.arch}getCredentials(){return this._credentials}};class Zt extends H{constructor(t){super(T.TOPIC_FND,t),Ke(this,"_contacts",{})}_processMetaSub(t){let s=Object.getOwnPropertyNames(this._contacts).length;this._contacts={};for(let i in t){let n=t[i];const a=n.topic?n.topic:n.user;n=(0,A.mergeToCache)(this._contacts,a,n),s++,this.onMetaSub&&this.onMetaSub(n)}s>0&&this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._contacts))}publish(){return Promise.reject(new Error("Publishing to 'fnd' is not supported"))}setMeta(t){return Object.getPrototypeOf(Zt.prototype).setMeta.call(this,t).then(()=>{Object.keys(this._contacts).length>0&&(this._contacts={},this.onSubsUpdated&&this.onSubsUpdated([]))})}contacts(t,s){const i=t||this.onMetaSub;if(i)for(let n in this._contacts)i.call(s,this._contacts[n],n,this._contacts)}}q.TopicFnd=Zt;var ft={};return function(e){(function(){Object.defineProperty(ft,"__esModule",{value:!0}),Object.defineProperty(ft,"AccessMode",{enumerable:!0,get:function(){return t.default}}),Object.defineProperty(ft,"Drafty",{enumerable:!0,get:function(){return a.default}}),ft.Tinode=void 0;var t=b(tt),s=function(d,r){if(d&&d.__esModule)return d;if(d===null||typeof d!="object"&&typeof d!="function")return{default:d};var c=function(O){if(typeof WeakMap!="function")return null;var ct=new WeakMap,ht=new WeakMap;return function(kt){return kt?ht:ct}(O)}(void 0);if(c&&c.has(d))return c.get(d);var h={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var _ in d)if(_!=="default"&&Object.prototype.hasOwnProperty.call(d,_)){var y=f?Object.getOwnPropertyDescriptor(d,_):null;y&&(y.get||y.set)?Object.defineProperty(h,_,y):h[_]=d[_]}return h.default=d,c&&c.set(d,h),h}(w),i=b(Pt),n=b(Rt),a=b(St),o=b(Ot),l=b(Tt);function b(d){return d&&d.__esModule?d:{default:d}}function g(d,r){(function(c,h){if(h.has(c))throw new TypeError("Cannot initialize the same private elements twice on an object")})(d,r),r.add(d)}function m(d,r,c){return r in d?Object.defineProperty(d,r,{value:c,enumerable:!0,configurable:!0,writable:!0}):d[r]=c,d}function u(d,r,c){if(!r.has(d))throw new TypeError("attempted to get private field on non-instance");return c}let v,M,E;function P(d){return btoa(encodeURIComponent(d).replace(/%([0-9A-F]{2})/g,function(r,c){return String.fromCharCode("0x"+c)}))}function C(d,r){return typeof r=="string"&&r.length>128?"<"+r.length+", bytes: "+r.substring(0,12)+"..."+r.substring(r.length-12)+">":function(c,h){if(h instanceof Date)h=(0,A.rfc3339DateString)(h);else if(h instanceof t.default)h=h.jsonHelper();else if(h==null||h===!1||Array.isArray(h)&&h.length==0||typeof h=="object"&&Object.keys(h).length==0)return;return h}(0,r)}typeof WebSocket<"u"&&(v=WebSocket),typeof XMLHttpRequest<"u"&&(M=XMLHttpRequest),typeof indexedDB<"u"&&(E=indexedDB),function(){const d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";typeof btoa>"u"&&(e.btoa=function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",c=r,h="";for(let f,_=0,y=0,O=d;c.charAt(0|y)||(O="=",y%1);h+=O.charAt(63&_>>8-y%1*8)){if(f=c.charCodeAt(y+=3/4),f>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");_=_<<8|f}return h}),typeof atob>"u"&&(e.atob=function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",c=r.replace(/=+$/,""),h="";if(c.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let f,_=0,y=0,O=0;f=c.charAt(O++);~f&&(y=_%4?64*y+f:f,_++%4)?h+=String.fromCharCode(255&y>>(-2*_&6)):0)f=d.indexOf(f);return h}),typeof window>"u"&&(e.window={WebSocket:v,XMLHttpRequest:M,indexedDB:E,URL:{createObjectURL:function(){throw new Error("Unable to use URL.createObjectURL in a non-browser application")}}}),i.default.setNetworkProviders(v,M),o.default.setNetworkProvider(M),n.default.setDatabaseProvider(E)}();var I=new WeakSet,k=new WeakSet,R=new WeakSet,Y=new WeakSet,nt=new WeakSet,Xe=new WeakSet,$e=new WeakSet,W=new WeakSet,Nt=new WeakSet,V=new WeakSet,Ut=new WeakSet,te=new WeakSet,ee=new WeakSet,se=new WeakSet;class L{constructor(r,c){if(g(this,se),g(this,ee),g(this,te),g(this,Ut),g(this,V),g(this,Nt),g(this,W),g(this,$e),g(this,Xe),g(this,nt),g(this,Y),g(this,R),g(this,k),g(this,I),m(this,"_host",void 0),m(this,"_secure",void 0),m(this,"_appName",void 0),m(this,"_apiKey",void 0),m(this,"_browser",""),m(this,"_platform",void 0),m(this,"_hwos","undefined"),m(this,"_humanLanguage","xx"),m(this,"_loggingEnabled",!1),m(this,"_trimLongStrings",!1),m(this,"_myUID",null),m(this,"_authenticated",!1),m(this,"_login",null),m(this,"_authToken",null),m(this,"_inPacketCount",0),m(this,"_messageId",Math.floor(65535*Math.random()+65535)),m(this,"_serverInfo",null),m(this,"_deviceToken",null),m(this,"_pendingPromises",{}),m(this,"_expirePromises",null),m(this,"_connection",null),m(this,"_persist",!1),m(this,"_db",null),m(this,"_cache",{}),m(this,"onWebsocketOpen",void 0),m(this,"onConnect",void 0),m(this,"onDisconnect",void 0),m(this,"onLogin",void 0),m(this,"onCtrlMessage",void 0),m(this,"onDataMessage",void 0),m(this,"onPresMessage",void 0),m(this,"onMessage",void 0),m(this,"onRawMessage",void 0),m(this,"onNetworkProbe",void 0),m(this,"onAutoreconnectIteration",void 0),this._host=r.host,this._secure=r.secure,this._appName=r.appName||"Undefined",this._apiKey=r.apiKey,this._platform=r.platform||"web",typeof navigator<"u"&&(this._browser=function(h,f){h=h||"";let _,y="";/reactnative/i.test(f)&&(y="ReactNative; ");let O=(h=h.replace(" (KHTML, like Gecko)","")).match(/(AppleWebKit\/[.\d]+)/i);if(O){const ct=["edg","chrome","safari","mobile","version"];let ht,kt=h.substr(O.index+O[0].length).split(" "),$=[];for(let yt=0;yt<kt.length;yt++){let rt=/([\w.]+)[\/]([\.\d]+)/.exec(kt[yt]);rt&&($.push([rt[1],rt[2],ct.findIndex(ws=>rt[1].toLowerCase().startsWith(ws))]),rt[1]=="Version"&&(ht=rt[2]))}$.sort((yt,rt)=>yt[2]-rt[2]),$.length>0?($[0][0].toLowerCase().startsWith("edg")?$[0][0]="Edge":$[0][0]=="OPR"?$[0][0]="Opera":$[0][0]=="Safari"&&ht&&($[0][1]=ht),_=$[0][0]+"/"+$[0][1]):_=O[1]}else/firefox/i.test(h)?(O=/Firefox\/([.\d]+)/g.exec(h),_=O?"Firefox/"+O[1]:"Firefox/?"):(O=/([\w.]+)\/([.\d]+)/.exec(h),O?_=O[1]+"/"+O[2]:(O=h.split(" "),_=O[0]));if(O=_.split("/"),O.length>1){const ct=O[1].split("."),ht=ct[1]?"."+ct[1].substr(0,2):"";_=`${O[0]}/${ct[0]}${ht}`}return y+_}(navigator.userAgent,navigator.product),this._hwos=navigator.platform,this._humanLanguage=navigator.language||"en-US"),i.default.logger=this.logger,a.default.logger=this.logger,r.transport!="lp"&&r.transport!="ws"&&(r.transport=function(){if(typeof window=="object"){if(window.WebSocket)return"ws";if(window.XMLHttpRequest)return"lp"}return null}()),this._connection=new i.default(r,s.PROTOCOL_VERSION,!0),this._connection.onMessage=h=>{u(this,Y,gs).call(this,h)},this._connection.onOpen=()=>{u(this,nt,ms).call(this)},this._connection.onDisconnect=(h,f)=>{u(this,Xe,_s).call(this,h,f)},this._connection.onAutoreconnectIteration=(h,f)=>{this.onAutoreconnectIteration&&this.onAutoreconnectIteration(h,f)},this._persist=r.persist,this._db=new n.default(h=>{this.logger("DB",h)},this.logger),this._persist){const h=[];this._db.initDatabase().then(f=>this._db.mapTopics(_=>{let y=u(this,V,B).call(this,"topic",_.name);y||(y=_.name==s.TOPIC_ME?new q.TopicMe:_.name==s.TOPIC_FND?new q.TopicFnd:new q.Topic(_.name),this._db.deserializeTopic(y,_),u(this,ee,Ye).call(this,y),y._cachePutSelf(),delete y._new,h.push(y._loadMessages(this._db)))})).then(f=>this._db.mapUsers(_=>{u(this,Nt,ne).call(this,"user",_.uid,(0,A.mergeObj)({},_.public))})).then(f=>Promise.all(h)).then(f=>{c&&c(),this.logger("Persistent cache initialized.")}).catch(f=>{c&&c(f),this.logger("Failed to initialize persistent cache:",f)})}else this._db.deleteDatabase().then(h=>{c&&c()})}logger(r){if(this._loggingEnabled){const _=new Date,y=("0"+_.getUTCHours()).slice(-2)+":"+("0"+_.getUTCMinutes()).slice(-2)+":"+("0"+_.getUTCSeconds()).slice(-2)+"."+("00"+_.getUTCMilliseconds()).slice(-3);for(var c=arguments.length,h=new Array(c>1?c-1:0),f=1;f<c;f++)h[f-1]=arguments[f];console.log("["+y+"]",r,h.join(" "))}}static credential(r,c,h,f){return typeof r=="object"&&({val:c,params:h,resp:f,meth:r}=r),r&&(c||f)?[{meth:r,val:c,resp:f,params:h}]:null}static topicType(r){return q.Topic.topicType(r)}static isMeTopicName(r){return q.Topic.isMeTopicName(r)}static isGroupTopicName(r){return q.Topic.isGroupTopicName(r)}static isP2PTopicName(r){return q.Topic.isP2PTopicName(r)}static isCommTopicName(r){return q.Topic.isCommTopicName(r)}static isNewGroupTopicName(r){return q.Topic.isNewGroupTopicName(r)}static isChannelTopicName(r){return q.Topic.isChannelTopicName(r)}static getVersion(){return s.VERSION}static setNetworkProviders(r,c){v=r,M=c,i.default.setNetworkProviders(v,M),o.default.setNetworkProvider(M)}static setDatabaseProvider(r){E=r,n.default.setDatabaseProvider(E)}static getLibrary(){return s.LIBRARY}static isNullValue(r){return r===s.DEL_CHAR}getNextUniqueId(){return this._messageId!=0?""+this._messageId++:void 0}connect(r){return this._connection.connect(r)}reconnect(r){this._connection.reconnect(r)}disconnect(){this._connection.disconnect()}clearStorage(){return this._db.isReady()?this._db.deleteDatabase():Promise.resolve()}initStorage(){return this._db.isReady()?Promise.resolve():this._db.initDatabase()}networkProbe(){this._connection.probe()}isConnected(){return this._connection.isConnected()}isAuthenticated(){return this._authenticated}authorizeURL(r){if(typeof r!="string")return r;if((0,A.isUrlRelative)(r)){const c="scheme://host/",h=new URL(r,c);this._apiKey&&h.searchParams.append("apikey",this._apiKey),this._authToken&&this._authToken.token&&(h.searchParams.append("auth","token"),h.searchParams.append("secret",this._authToken.token)),r=h.toString().substring(c.length-1)}return r}account(r,c,h,f,_){const y=u(this,W,z).call(this,"acc");return y.acc.user=r,y.acc.scheme=c,y.acc.secret=h,y.acc.login=f,_&&(y.acc.desc.defacs=_.defacs,y.acc.desc.public=_.public,y.acc.desc.private=_.private,y.acc.desc.trusted=_.trusted,y.acc.tags=_.tags,y.acc.cred=_.cred,y.acc.token=_.token,Array.isArray(_.attachments)&&_.attachments.length>0&&(y.extra={attachments:_.attachments.filter(O=>(0,A.isUrlRelative)(O))})),u(this,R,F).call(this,y,y.acc.id)}createAccount(r,c,h,f){let _=this.account(s.USER_NEW,r,c,h,f);return h&&(_=_.then(y=>u(this,se,Ze).call(this,y))),_}createAccountBasic(r,c,h){return r=r||"",c=c||"",this.createAccount("basic",P(r+":"+c),!0,h)}updateAccountBasic(r,c,h,f){return c=c||"",h=h||"",this.account(r,"basic",P(c+":"+h),!1,f)}hello(){const r=u(this,W,z).call(this,"hi");return u(this,R,F).call(this,r,r.hi.id).then(c=>(this._connection.backoffReset(),c.params&&(this._serverInfo=c.params),this.onConnect&&this.onConnect(),c)).catch(c=>{this._connection.reconnect(!0),this.onDisconnect&&this.onDisconnect(c)})}setDeviceToken(r){let c=!1;return(r=r||null)!=this._deviceToken&&(this._deviceToken=r,this.isConnected()&&this.isAuthenticated()&&(u(this,R,F).call(this,{hi:{dev:r||L.DEL_CHAR}}),c=!0)),c}login(r,c,h){const f=u(this,W,z).call(this,"login");return f.login.scheme=r,f.login.secret=c,f.login.cred=h,u(this,R,F).call(this,f,f.login.id).then(_=>u(this,se,Ze).call(this,_))}loginBasic(r,c,h){return this.login("basic",P(r+":"+c),h).then(f=>(this._login=r,f))}loginToken(r,c){return this.login("token",r,c)}requestResetAuthSecret(r,c,h){return this.login("reset",P(r+":"+c+":"+h))}getAuthToken(){return this._authToken&&this._authToken.expires.getTime()>Date.now()?this._authToken:(this._authToken=null,null)}setAuthToken(r){this._authToken=r}subscribe(r,c,h){const f=u(this,W,z).call(this,"sub",r);if(r||(r=s.TOPIC_NEW),f.sub.get=c,h){if(h.sub&&(f.sub.set.sub=h.sub),h.desc){const _=h.desc;L.isNewGroupTopicName(r)?f.sub.set.desc=_:L.isP2PTopicName(r)&&_.defacs&&(f.sub.set.desc={defacs:_.defacs})}Array.isArray(h.attachments)&&h.attachments.length>0&&(f.extra={attachments:h.attachments.filter(_=>(0,A.isUrlRelative)(_))}),h.tags&&(f.sub.set.tags=h.tags)}return u(this,R,F).call(this,f,f.sub.id)}leave(r,c){const h=u(this,W,z).call(this,"leave",r);return h.leave.unsub=c,u(this,R,F).call(this,h,h.leave.id)}createMessage(r,c,h){const f=u(this,W,z).call(this,"pub",r);let _=typeof c=="string"?a.default.parse(c):c;return _&&!a.default.isPlainText(_)&&(f.pub.head={mime:a.default.getContentType()},c=_),f.pub.noecho=h,f.pub.content=c,f.pub}publish(r,c,h){return this.publishMessage(this.createMessage(r,c,h))}publishMessage(r,c){(r=Object.assign({},r)).seq=void 0,r.from=void 0,r.ts=void 0;const h={pub:r};return c&&(h.extra={attachments:c.filter(f=>(0,A.isUrlRelative)(f))}),u(this,R,F).call(this,h,r.id)}oobNotification(r){switch(this.logger("oob: "+(this._trimLongStrings?JSON.stringify(r,C):r)),r.what){case"msg":if(!r.seq||r.seq<1||!r.topic||!this.isConnected())break;const c=u(this,V,B).call(this,"topic",r.topic);if(!c||c.isSubscribed())break;c.maxMsgSeq()<r.seq&&(c.isChannelType()&&c._updateReceived(r.seq,"fake-uid"),r.xfrom&&!u(this,V,B).call(this,"user",r.xfrom)&&this.getMeta(r.xfrom,new l.default().withDesc().build()).catch(y=>{this.logger("Failed to get the name of a new sender",y)}),c.subscribe(null).then(y=>c.getMeta(new l.default(c).withLaterData(24).withLaterDel(24).build())).then(y=>{c.leaveDelayed(!1,1e3)}).catch(y=>{this.logger("On push data fetch failed",y)}).finally(y=>{this.getMeTopic()._refreshContact("msg",c)}));break;case"read":this.getMeTopic()._routePres({what:"read",seq:r.seq});break;case"sub":if(!this.isMe(r.xfrom))break;let h={given:r.modeGiven,want:r.modeWant},f=new t.default(h),_=f.mode&&f.mode!=t.default._NONE?{what:"acs",src:r.topic,dacs:h}:{what:"gone",src:r.topic};this.getMeTopic()._routePres(_);break;default:this.logger("Unknown push type ignored",r.what)}}getMeta(r,c){const h=u(this,W,z).call(this,"get",r);return h.get=(0,A.mergeObj)(h.get,c),u(this,R,F).call(this,h,h.get.id)}setMeta(r,c){const h=u(this,W,z).call(this,"set",r),f=[];return c&&(["desc","sub","tags","cred","ephemeral"].forEach(function(_){c.hasOwnProperty(_)&&(f.push(_),h.set[_]=c[_])}),Array.isArray(c.attachments)&&c.attachments.length>0&&(h.extra={attachments:c.attachments.filter(_=>(0,A.isUrlRelative)(_))})),f.length==0?Promise.reject(new Error("Invalid {set} parameters")):u(this,R,F).call(this,h,h.set.id)}delMessages(r,c,h){const f=u(this,W,z).call(this,"del",r);return f.del.what="msg",f.del.delseq=c,f.del.hard=h,u(this,R,F).call(this,f,f.del.id)}delTopic(r,c){const h=u(this,W,z).call(this,"del",r);return h.del.what="topic",h.del.hard=c,u(this,R,F).call(this,h,h.del.id)}delSubscription(r,c){const h=u(this,W,z).call(this,"del",r);return h.del.what="sub",h.del.user=c,u(this,R,F).call(this,h,h.del.id)}delCredential(r,c){const h=u(this,W,z).call(this,"del",s.TOPIC_ME);return h.del.what="cred",h.del.cred={meth:r,val:c},u(this,R,F).call(this,h,h.del.id)}delCurrentUser(r){const c=u(this,W,z).call(this,"del",null);return c.del.what="user",c.del.hard=r,u(this,R,F).call(this,c,c.del.id).then(h=>{this._myUID=null})}note(r,c,h){if(h<=0||h>=s.LOCAL_SEQID)throw new Error("Invalid message id "+h);const f=u(this,W,z).call(this,"note",r);f.note.what=c,f.note.seq=h,u(this,R,F).call(this,f)}noteKeyPress(r){const c=u(this,W,z).call(this,"note",r);c.note.what="kp",u(this,R,F).call(this,c)}videoCall(r,c,h,f){const _=u(this,W,z).call(this,"note",r);_.note.seq=c,_.note.what="call",_.note.event=h,_.note.payload=f,u(this,R,F).call(this,_,_.note.id)}getTopic(r){let c=u(this,V,B).call(this,"topic",r);return!c&&r&&(c=r==s.TOPIC_ME?new q.TopicMe:r==s.TOPIC_FND?new q.TopicFnd:new q.Topic(r),u(this,ee,Ye).call(this,c),c._cachePutSelf()),c}cacheGetTopic(r){return u(this,V,B).call(this,"topic",r)}cacheRemTopic(r){u(this,Ut,re).call(this,"topic",r)}mapTopics(r,c){u(this,te,Je).call(this,"topic",r,c)}isTopicCached(r){return!!u(this,V,B).call(this,"topic",r)}newGroupTopicName(r){return(r?s.TOPIC_NEW_CHAN:s.TOPIC_NEW)+this.getNextUniqueId()}getMeTopic(){return this.getTopic(s.TOPIC_ME)}getFndTopic(){return this.getTopic(s.TOPIC_FND)}getLargeFileHelper(){return new o.default(this,s.PROTOCOL_VERSION)}getCurrentUserID(){return this._myUID}isMe(r){return this._myUID===r}getCurrentLogin(){return this._login}getServerInfo(){return this._serverInfo}report(r,c){return this.publish(s.TOPIC_SYS,a.default.attachJSON(null,{action:r,target:c}))}getServerParam(r,c){return this._serverInfo&&this._serverInfo[r]||c}enableLogging(r,c){this._loggingEnabled=r,this._trimLongStrings=r&&c}setHumanLanguage(r){r&&(this._humanLanguage=r)}isTopicOnline(r){const c=u(this,V,B).call(this,"topic",r);return c&&c.online}getTopicAccessMode(r){const c=u(this,V,B).call(this,"topic",r);return c?c.acs:null}wantAkn(r){this._messageId=r?Math.floor(16777215*Math.random()+16777215):0}}function fs(d){let r=null;return d&&(r=new Promise((c,h)=>{this._pendingPromises[d]={resolve:c,reject:h,ts:new Date}})),r}function ie(d,r,c,h){const f=this._pendingPromises[d];f&&(delete this._pendingPromises[d],r>=200&&r<400?f.resolve&&f.resolve(c):f.reject&&f.reject(new Error(`${h} (${r})`)))}function F(d,r){let c;r&&(c=u(this,I,fs).call(this,r)),d=(0,A.simplify)(d);let h=JSON.stringify(d);this.logger("out: "+(this._trimLongStrings?JSON.stringify(d,C):h));try{this._connection.sendText(h)}catch(f){if(!r)throw f;u(this,k,ie).call(this,r,i.default.NETWORK_ERROR,null,f.message)}return c}function gs(d){if(!d)return;if(this._inPacketCount++,this.onRawMessage&&this.onRawMessage(d),d==="0")return void(this.onNetworkProbe&&this.onNetworkProbe());let r=JSON.parse(d,A.jsonParseHelper);r?(this.logger("in: "+(this._trimLongStrings?JSON.stringify(r,C):d)),this.onMessage&&this.onMessage(r),r.ctrl?(this.onCtrlMessage&&this.onCtrlMessage(r.ctrl),r.ctrl.id&&u(this,k,ie).call(this,r.ctrl.id,r.ctrl.code,r.ctrl,r.ctrl.text),setTimeout(()=>{if(r.ctrl.code==205&&r.ctrl.text=="evicted"){const c=u(this,V,B).call(this,"topic",r.ctrl.topic);c&&(c._resetSub(),r.ctrl.params&&r.ctrl.params.unsub&&c._gone())}else if(r.ctrl.code<300&&r.ctrl.params){if(r.ctrl.params.what=="data"){const c=u(this,V,B).call(this,"topic",r.ctrl.topic);c&&c._allMessagesReceived(r.ctrl.params.count)}else if(r.ctrl.params.what=="sub"){const c=u(this,V,B).call(this,"topic",r.ctrl.topic);c&&c._processMetaSub([])}}},0)):setTimeout(()=>{if(r.meta){const c=u(this,V,B).call(this,"topic",r.meta.topic);c&&c._routeMeta(r.meta),r.meta.id&&u(this,k,ie).call(this,r.meta.id,200,r.meta,"META"),this.onMetaMessage&&this.onMetaMessage(r.meta)}else if(r.data){const c=u(this,V,B).call(this,"topic",r.data.topic);c&&c._routeData(r.data),this.onDataMessage&&this.onDataMessage(r.data)}else if(r.pres){const c=u(this,V,B).call(this,"topic",r.pres.topic);c&&c._routePres(r.pres),this.onPresMessage&&this.onPresMessage(r.pres)}else if(r.info){const c=u(this,V,B).call(this,"topic",r.info.topic);c&&c._routeInfo(r.info),this.onInfoMessage&&this.onInfoMessage(r.info)}else this.logger("ERROR: Unknown packet received.")},0)):(this.logger("in: "+d),this.logger("ERROR: failed to parse data"))}function ms(){this._expirePromises||(this._expirePromises=setInterval(()=>{const d=new Error("Timeout (504)"),r=new Date(new Date().getTime()-s.EXPIRE_PROMISES_TIMEOUT);for(let c in this._pendingPromises){let h=this._pendingPromises[c];h&&h.ts<r&&(this.logger("Promise expired",c),delete this._pendingPromises[c],h.reject&&h.reject(d))}},s.EXPIRE_PROMISES_PERIOD)),this.hello()}function _s(d,r){this._inPacketCount=0,this._serverInfo=null,this._authenticated=!1,this._expirePromises&&(clearInterval(this._expirePromises),this._expirePromises=null),u(this,te,Je).call(this,"topic",(c,h)=>{c._resetSub()});for(let c in this._pendingPromises){const h=this._pendingPromises[c];h&&h.reject&&h.reject(d)}this._pendingPromises={},this.onDisconnect&&this.onDisconnect(d)}function bs(){return this._appName+" ("+(this._browser?this._browser+"; ":"")+this._hwos+"); "+s.LIBRARY}function z(d,r){switch(d){case"hi":return{hi:{id:this.getNextUniqueId(),ver:s.VERSION,ua:u(this,$e,bs).call(this),dev:this._deviceToken,lang:this._humanLanguage,platf:this._platform}};case"acc":return{acc:{id:this.getNextUniqueId(),user:null,scheme:null,secret:null,login:!1,tags:null,desc:{},cred:{}}};case"login":return{login:{id:this.getNextUniqueId(),scheme:null,secret:null}};case"sub":return{sub:{id:this.getNextUniqueId(),topic:r,set:{},get:{}}};case"leave":return{leave:{id:this.getNextUniqueId(),topic:r,unsub:!1}};case"pub":return{pub:{id:this.getNextUniqueId(),topic:r,noecho:!1,head:null,content:{}}};case"get":return{get:{id:this.getNextUniqueId(),topic:r,what:null,desc:{},sub:{},data:{}}};case"set":return{set:{id:this.getNextUniqueId(),topic:r,desc:{},sub:{},tags:[],ephemeral:{}}};case"del":return{del:{id:this.getNextUniqueId(),topic:r,what:null,delseq:null,user:null,hard:!1}};case"note":return{note:{topic:r,what:null,seq:void 0}};default:throw new Error("Unknown packet type requested: "+d)}}function ne(d,r,c){this._cache[d+":"+r]=c}function B(d,r){return this._cache[d+":"+r]}function re(d,r){delete this._cache[d+":"+r]}function Je(d,r,c){const h=d?d+":":void 0;for(let f in this._cache)if((!h||f.indexOf(h)==0)&&r.call(c,this._cache[f],f))break}function Ye(d){d._tinode=this,d._cacheGetUser=r=>{const c=u(this,V,B).call(this,"user",r);if(c)return{user:r,public:(0,A.mergeObj)({},c)}},d._cachePutUser=(r,c)=>{u(this,Nt,ne).call(this,"user",r,(0,A.mergeObj)({},c.public))},d._cacheDelUser=r=>{u(this,Ut,re).call(this,"user",r)},d._cachePutSelf=r=>{u(this,Nt,ne).call(this,"topic",d.name,d)},d._cacheDelSelf=r=>{u(this,Ut,re).call(this,"topic",d.name)}}function Ze(d){return d.params&&d.params.user&&(this._myUID=d.params.user,this._authenticated=d&&d.code>=200&&d.code<300,d.params&&d.params.token&&d.params.expires?this._authToken={token:d.params.token,expires:d.params.expires}:this._authToken=null,this.onLogin&&this.onLogin(d.code,d.text)),d}ft.Tinode=L,L.MESSAGE_STATUS_NONE=s.MESSAGE_STATUS_NONE,L.MESSAGE_STATUS_QUEUED=s.MESSAGE_STATUS_QUEUED,L.MESSAGE_STATUS_SENDING=s.MESSAGE_STATUS_SENDING,L.MESSAGE_STATUS_FAILED=s.MESSAGE_STATUS_FAILED,L.MESSAGE_STATUS_SENT=s.MESSAGE_STATUS_SENT,L.MESSAGE_STATUS_RECEIVED=s.MESSAGE_STATUS_RECEIVED,L.MESSAGE_STATUS_READ=s.MESSAGE_STATUS_READ,L.MESSAGE_STATUS_TO_ME=s.MESSAGE_STATUS_TO_ME,L.MESSAGE_STATUS_DEL_RANGE=s.MESSAGE_STATUS_DEL_RANGE,L.DEL_CHAR=s.DEL_CHAR,L.MAX_MESSAGE_SIZE="maxMessageSize",L.MAX_SUBSCRIBER_COUNT="maxSubscriberCount",L.MAX_TAG_COUNT="maxTagCount",L.MAX_FILE_UPLOAD_SIZE="maxFileUploadSize"}).call(this)}.call(this,typeof ts<"u"?ts:typeof self<"u"?self:typeof window<"u"?window:{}),ft})})(Ss);export{Ss as t};
